0ƒ‚4	*†H†÷ ƒ‚$0ƒ‚10	`†He0ƒcÍ	*†H†÷ ƒc½ƒc¸using System;
using System.IO;
using System.Security.Cryptography;
using System.Security.Cryptography.X509Certificates;
using System.Security.Cryptography.Pkcs;
using System.Text;
using System.Threading.Tasks;
using System.Net.Http;
using System.Runtime.InteropServices;
using System.Collections.Generic;
using System.Windows.Forms;
using Org.BouncyCastle.Asn1;
using Org.BouncyCastle.Asn1.Cmp;
using Org.BouncyCastle.Tsp;
using Org.BouncyCastle.Cms;
using System.Linq;
using System.Reflection;

namespace SmartFileCrypto
{
    public class Program
    {
        // å¢åŠ å…¨åŸŸè®Šæ•¸ä¾†æ§åˆ¶è©³ç´°è¼¸å‡º
        private static bool _debugMode = false;
        
        static async Task Main(string[] args)
        {
            try
            {
                if (args.Length < 1)
                {
                    PrintUsage();
                    return;
                }

                string command = args[0].ToLower();
                
                // æª¢æŸ¥å…¨åŸŸèª¿è©¦æ¨¡å¼
                for (int i = 1; i < args.Length; i++)
                {
                    if (args[i].ToLower() == "--debug" || args[i].ToLower() == "--verbose")
                    {
                        _debugMode = true;
                        Console.WriteLine("å·²å•Ÿç”¨èª¿è©¦æ¨¡å¼ï¼Œå°‡é¡¯ç¤ºè©³ç´°è¨Šæ¯");
                        break;
                    }
                }
                
                // é¡¯ç¤ºç‰ˆæœ¬è³‡è¨Š
                Console.WriteLine($"SmartFileCrypto - æª”æ¡ˆåŠ å¯†èˆ‡ç°½ç« å·¥å…· v{Assembly.GetExecutingAssembly().GetName().Version}");
                Console.WriteLine();
                
                switch (command)
                {
                    case "sign":
                        await HandleSignCommand(args);
                        break;

                    case "verify":
                        if (args.Length < 2)
                        {
                            Console.WriteLine("éŒ¯èª¤: é©—è­‰å‘½ä»¤éœ€è¦æŒ‡å®šæª”æ¡ˆè·¯å¾‘");
                            PrintUsage();
                            return;
                        }
                        
                        // æ‰¾å‡ºæª”æ¡ˆè·¯å¾‘ï¼ˆç¬¬ä¸€å€‹éåƒæ•¸é¸é …ï¼‰
                        string verifyFilePath = FindFilePath(args, 1);
                        if (verifyFilePath == null)
                        {
                            Console.WriteLine("éŒ¯èª¤: æœªæŒ‡å®šæœ‰æ•ˆçš„æª”æ¡ˆè·¯å¾‘");
                            PrintUsage();
                            return;
                        }
                        
                        // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                        if (!File.Exists(verifyFilePath))
                        {
                            Console.WriteLine($"éŒ¯èª¤: æ‰¾ä¸åˆ°æª”æ¡ˆ '{verifyFilePath}'");
                            return;
                        }
                        
                        // æª¢æŸ¥æ˜¯å¦è¦æå–å…§å®¹
                        bool extractContent = false;
                        for (int i = 1; i < args.Length; i++)
                        {
                            if (args[i].ToLower() == "--extract-content")
                            {
                                extractContent = true;
                                break;
                            }
                        }
                        
                        VerifySignature(verifyFilePath, extractContent);
                        break;

                    case "encrypt":
                        await HandleEncryptCommand(args);
                        break;

                    case "decrypt":
                        if (args.Length < 2)
                        {
                            Console.WriteLine("éŒ¯èª¤: è§£å¯†å‘½ä»¤éœ€è¦æŒ‡å®šæª”æ¡ˆè·¯å¾‘");
                            PrintUsage();
                            return;
                        }
                        
                        // æ‰¾å‡ºæª”æ¡ˆè·¯å¾‘ï¼ˆç¬¬ä¸€å€‹éåƒæ•¸é¸é …ï¼‰
                        string decryptFilePath = FindFilePath(args, 1);
                        if (decryptFilePath == null)
                        {
                            Console.WriteLine("éŒ¯èª¤: æœªæŒ‡å®šæœ‰æ•ˆçš„æª”æ¡ˆè·¯å¾‘");
                            PrintUsage();
                            return;
                        }
                        
                        // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                        if (!File.Exists(decryptFilePath))
                        {
                            Console.WriteLine($"éŒ¯èª¤: æ‰¾ä¸åˆ°æª”æ¡ˆ '{decryptFilePath}'");
                            return;
                        }
                        
                        DecryptFile(decryptFilePath);
                        break;

                    case "list-certs":
                        ListCertificates();
                        break;

                    default:
                        Console.WriteLine($"æœªçŸ¥å‘½ä»¤: {command}");
                        PrintUsage();
                        break;
                }
            }
            catch (UnauthorizedAccessException ex)
            {
                Console.WriteLine($"æ¬Šé™éŒ¯èª¤: {ex.Message}");
                Console.WriteLine("è«‹ç¢ºä¿æ‚¨æœ‰è¶³å¤ çš„æ¬Šé™å­˜å–æª”æ¡ˆå’Œæ†‘è­‰ã€‚");
            }
            catch (System.Security.Cryptography.CryptographicException ex)
            {
                Console.WriteLine($"åŠ å¯†æ“ä½œéŒ¯èª¤: {ex.Message}");
                Console.WriteLine("å¯èƒ½æ˜¯æ†‘è­‰å•é¡Œæˆ–åŠ å¯†æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ†‘è­‰ç‹€æ…‹å’Œæœ‰æ•ˆæ€§ã€‚");
            }
            catch (FileNotFoundException ex)
            {
                Console.WriteLine($"æª”æ¡ˆä¸å­˜åœ¨: {ex.Message}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"æ“ä½œå¤±æ•—: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"è©³ç´°éŒ¯èª¤: {ex.InnerException.Message}");
                }
                
                if (_debugMode)
                {
                    Console.WriteLine("å®Œæ•´éŒ¯èª¤å †ç–Š:");
                    Console.WriteLine(ex.ToString());
                }
            }
        }

        private static void PrintUsage()
        {
            Console.WriteLine("SmartFileCrypto - æª”æ¡ˆåŠ å¯†èˆ‡ç°½ç« å·¥å…·");
            Console.WriteLine();
            Console.WriteLine("ä½¿ç”¨æ–¹å¼:");
            Console.WriteLine("  SmartFileCrypto <å‘½ä»¤> [é¸é …] <æª”æ¡ˆè·¯å¾‘>");
            Console.WriteLine();
            Console.WriteLine("å¯ç”¨å‘½ä»¤:");
            Console.WriteLine("  sign       ä½¿ç”¨æ†‘è­‰ç°½ç½²æª”æ¡ˆ");
            Console.WriteLine("  verify     é©—è­‰å·²ç°½ç« æª”æ¡ˆ");
            Console.WriteLine("  encrypt    ä½¿ç”¨æ†‘è­‰åŠ å¯†æª”æ¡ˆ");
            Console.WriteLine("  decrypt    ä½¿ç”¨æ†‘è­‰è§£å¯†æª”æ¡ˆ");
            Console.WriteLine("  list-certs åˆ—å‡ºå¯ç”¨çš„æ†‘è­‰");
            Console.WriteLine();
            Console.WriteLine("å¸¸ç”¨é¸é …:");
            Console.WriteLine("  --cert=<è­˜åˆ¥ç¢¼>      æŒ‡å®šè¦ä½¿ç”¨çš„æ†‘è­‰ï¼Œå¯ä»¥æ˜¯ä¸»é¡Œåç¨±çš„ä¸€éƒ¨åˆ†æˆ–åºè™Ÿ");
            Console.WriteLine("  --sha1=<æŒ‡ç´‹>        ä½¿ç”¨SHA1æŒ‡ç´‹ç›´æ¥é¸æ“‡æ†‘è­‰");
            Console.WriteLine("  --cert-file=<è·¯å¾‘>   ä½¿ç”¨æ†‘è­‰æª”æ¡ˆé€²è¡ŒåŠ å¯† (åƒ…é©ç”¨æ–¼åŠ å¯†ï¼Œæ”¯æ´ .cer, .crt, .pem æ ¼å¼)");
            Console.WriteLine("  --hash=<ç®—æ³•>        æŒ‡å®šé›œæ¹Šæ¼”ç®—æ³• (SHA1, SHA256, SHA384, SHA512)ï¼Œé è¨­ç‚ºSHA384");
            Console.WriteLine("  --timestamp          æ–°å¢æ™‚é–“æˆ³è¨˜ (é è¨­ä½¿ç”¨ DigiCert æ™‚é–“æˆ³è¨˜ä¼ºæœå™¨)");
            Console.WriteLine("  --timestamp=<URL>    æŒ‡å®šè‡ªè¨‚æ™‚é–“æˆ³è¨˜ä¼ºæœå™¨URL");
            Console.WriteLine("  --include-content    åœ¨ç°½ç« ä¸­åŒ…å«åŸå§‹å…§å®¹ (ä¸ä½¿ç”¨åˆ†é›¢å¼ç°½ç« )");
            Console.WriteLine("  --extract-content    å¾ç°½ç« ä¸­æå–åŸå§‹å…§å®¹ (åƒ…é©ç”¨æ–¼é©—è­‰)");
            Console.WriteLine("  --debug              é¡¯ç¤ºè©³ç´°çš„è¨ºæ–·è¨Šæ¯");
            Console.WriteLine();
            Console.WriteLine("å‚™è¨»:");
            Console.WriteLine("  * å¦‚æœªæŒ‡å®šæ†‘è­‰ï¼Œç³»çµ±æœƒé¡¯ç¤ºæ†‘è­‰é¸æ“‡å°è©±æ¡†");
            Console.WriteLine("  * ç°½ç« æª”æ¡ˆå°‡ä½¿ç”¨ .p7s å‰¯æª”å");
            Console.WriteLine("  * ç°½ç« é è¨­ä¸åŒ…å«åŸå§‹æª”æ¡ˆå…§å®¹ (åˆ†é›¢å¼ç°½ç« )");
            Console.WriteLine("  * åŠ å¯†å¾Œçš„æª”æ¡ˆå°‡ä½¿ç”¨ .cms å‰¯æª”å");
            Console.WriteLine();
        }

        [StructLayout(LayoutKind.Sequential)]
        private struct CRYPTUI_SELECTCERTIFICATE_STRUCT
        {
            public uint dwSize;
            public IntPtr hwndParent;
            public uint dwFlags;
            public string szTitle;
            public uint dwDontUseColumn;
            public string szDisplayString;
            public IntPtr pFilterCallback;
            public IntPtr pDisplayCallback;
            public IntPtr pvCallbackData;
            public uint cDisplayStores;
            public IntPtr rghDisplayStores;
            public uint cStores;
            public IntPtr rghStores;
            public uint cPropSheetPages;
            public IntPtr rgPropSheetPages;
            public IntPtr hSelectedCertStore;
            public IntPtr pSelectedCertContext;
        }

        [DllImport("cryptui.dll", CharSet = CharSet.Auto, SetLastError = true)]
        private static extern IntPtr CryptUIDlgSelectCertificateW(
            ref CRYPTUI_SELECTCERTIFICATE_STRUCT pcsc);

        private static X509Certificate2 SelectCertificateFromUI(string operation = null)
        {
            // æ‰“é–‹å€‹äººå­˜æ”¾å€
            using (X509Store store = new X509Store(StoreName.My, StoreLocation.CurrentUser))
            {
                store.Open(OpenFlags.ReadOnly | OpenFlags.OpenExistingOnly);

                // æº–å‚™æ†‘è­‰åˆ—è¡¨
                X509Certificate2Collection collection = new X509Certificate2Collection();
                X509Certificate2Collection filteredCollection = new X509Certificate2Collection();
                
                // å…ˆåŠ å…¥æ‰€æœ‰è­‰æ›¸ä»¥ä¾›ç¨å¾Œç¯©é¸
                foreach (X509Certificate2 cert in store.Certificates)
                {
                    if (cert.HasPrivateKey)
                    {
                        collection.Add(cert);
                    }
                }

                if (collection.Count == 0)
                {
                    throw new Exception("æ‰¾ä¸åˆ°ä»»ä½•å…·æœ‰ç§é‘°çš„æ†‘è­‰ã€‚");
                }

                // æ ¹æ“šæ“ä½œéæ¿¾è­‰æ›¸
                if (operation == "sign")
                {
                    // åƒ…é¸æ“‡å…·æœ‰æ•¸ä½ç°½ç« èƒ½åŠ›çš„è­‰æ›¸
                    foreach (X509Certificate2 cert in collection)
                    {
                        bool hasSignatureCapability = false;
                        
                        // æª¢æŸ¥é‡‘é‘°ä½¿ç”¨æ“´å±•
                        foreach (X509Extension ext in cert.Extensions)
                        {
                            if (ext is X509KeyUsageExtension keyUsage)
                            {
                                // æª¢æŸ¥æ•¸ä½ç°½ç« æˆ–ä¸å¯å¦èªæ€§æ¨™èªŒï¼Œå…©è€…éƒ½å¯ç”¨æ–¼ç°½å
                                if ((keyUsage.KeyUsages & X509KeyUsageFlags.DigitalSignature) == X509KeyUsageFlags.DigitalSignature ||
                                    (keyUsage.KeyUsages & X509KeyUsageFlags.NonRepudiation) == X509KeyUsageFlags.NonRepudiation)
                                {
                                    hasSignatureCapability = true;
                                    break;
                                }
                            }
                            
                            // æª¢æŸ¥æ“´å±•é‡‘é‘°ä½¿ç”¨æ“´å±•
                            if (ext is X509EnhancedKeyUsageExtension enhancedKeyUsage)
                            {
                                foreach (var oid in enhancedKeyUsage.EnhancedKeyUsages)
                                {
                                    // æª¢æŸ¥æ˜¯å¦åŒ…å«ä»£ç¢¼ç°½ç« ã€æ–‡ä»¶ç°½ç« æˆ–å…¶ä»–ç°½åç›¸é—œçš„OID
                                    if (oid.Value == "1.3.6.1.5.5.7.3.3" || // Code Signing
                                        oid.Value == "1.3.6.1.4.1.311.10.3.12" || // Document Signing
                                        oid.Value == "1.2.840.113583.1.1.5") // Adobe PDF Signing
                                    {
                                        hasSignatureCapability = true;
                                        break;
                                    }
                                }
                                
                                if (hasSignatureCapability)
                                {
                                    break;
                                }
                            }
                        }
                        
                        // å¦‚æœé‡‘é‘°ä½¿ç”¨æ²’æœ‰æ˜ç¢ºç¦æ­¢ç°½ç« ï¼Œä¸”æ†‘è­‰å…·æœ‰ç§é‘°ï¼Œä¹Ÿè¦–ç‚ºå¯ç”¨æ–¼ç°½ç« 
                        if (!hasSignatureCapability)
                        {
                            bool hasExplicitlyDisabledSignature = false;
                            foreach (X509Extension ext in cert.Extensions)
                            {
                                if (ext is X509KeyUsageExtension keyUsage)
                                {
                                    // å¦‚æœæœ‰æ˜ç¢ºè¨­å®šä¸”æ’é™¤äº†æ•¸ä½ç°½ç« å’Œä¸å¯å¦èªæ€§ï¼Œå‰‡è¦–ç‚ºä¸å¯ç”¨æ–¼ç°½ç« 
                                    if ((keyUsage.KeyUsages & (X509KeyUsageFlags.DigitalSignature | X509KeyUsageFlags.NonRepudiation)) == 0)
                                    {
                                        hasExplicitlyDisabledSignature = true;
                                        break;
                                    }
                                }
                            }
                            
                            if (!hasExplicitlyDisabledSignature)
                            {
                                hasSignatureCapability = true;
                            }
                        }
                        
                        if (hasSignatureCapability)
                        {
                            filteredCollection.Add(cert);
                        }
                    }
                    
                    // å¦‚æœæ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è­‰æ›¸ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    if (filteredCollection.Count == 0)
                    {
                        throw new Exception("æ‰¾ä¸åˆ°ä»»ä½•å…·æœ‰æ•¸ä½ç°½ç« èƒ½åŠ›çš„æ†‘è­‰ã€‚");
                    }
                }
                else if (operation == "encrypt")
                {
                    // æ†‘è­‰ç¯©é¸æ¢ä»¶ï¼šå¯ç”¨æ–¼åŠ å¯†
                    // æª¢æŸ¥æ˜¯å¦åŒ…å«å…¬é‘°å’ŒåŠ å¯†ç”¨é€”
                    foreach (X509Certificate2 cert in collection)
                    {
                        bool canBeUsedForEncryption = false;
                        
                        // æª¢æŸ¥å…¬é‘°æ˜¯å¦å­˜åœ¨
                        if (cert.PublicKey != null && 
                            (cert.GetRSAPublicKey() != null || 
                             cert.GetECDiffieHellmanPublicKey() != null))
                        {
                            // æª¢æŸ¥é‡‘é‘°ä½¿ç”¨æ“´å±•
                            bool hasKeyUsageRestriction = false;
                            
                            foreach (X509Extension ext in cert.Extensions)
                            {
                                if (ext is X509KeyUsageExtension keyUsage)
                                {
                                    hasKeyUsageRestriction = true;
                                    
                                    // æª¢æŸ¥é‡‘é‘°åŠ å¯†æ¨™èªŒ
                                    if ((keyUsage.KeyUsages & X509KeyUsageFlags.KeyEncipherment) == X509KeyUsageFlags.KeyEncipherment ||
                                        (keyUsage.KeyUsages & X509KeyUsageFlags.DataEncipherment) == X509KeyUsageFlags.DataEncipherment)
                                    {
                                        canBeUsedForEncryption = true;
                                        break;
                                    }
                                }
                            }
                            
                            // å¦‚æœæ²’æœ‰æ˜ç¢ºçš„é‡‘é‘°ä½¿ç”¨é™åˆ¶ï¼Œå‰‡å‡è¨­å¯ä»¥ç”¨æ–¼åŠ å¯†
                            if (!hasKeyUsageRestriction)
                            {
                                canBeUsedForEncryption = true;
                            }
                        }
                        
                        if (canBeUsedForEncryption)
                        {
                            filteredCollection.Add(cert);
                        }
                    }
                    
                    // å¦‚æœæ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è­‰æ›¸ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    if (filteredCollection.Count == 0)
                    {
                        throw new Exception("æ‰¾ä¸åˆ°ä»»ä½•å¯ç”¨æ–¼åŠ å¯†çš„æ†‘è­‰ã€‚");
                    }
                }
                else
                {
                    // è‹¥æ²’æœ‰ç‰¹å®šæ“ä½œï¼Œé¡¯ç¤ºæ‰€æœ‰è­‰æ›¸
                    filteredCollection = collection;
                }

                // è¨­å®šå°è©±æ¡†æ¨™é¡Œå’Œæç¤ºè¨Šæ¯
                string dialogTitle = "é¸æ“‡æ†‘è­‰";
                string dialogMessage = "è«‹é¸æ“‡è¦ä½¿ç”¨çš„æ†‘è­‰";
                
                if (operation == "sign")
                {
                    dialogTitle = "é¸æ“‡ç°½ç½²æ†‘è­‰";
                    dialogMessage = "è«‹é¸æ“‡è¦ç”¨æ–¼ç°½ç½²æ–‡ä»¶çš„æ†‘è­‰ (åƒ…é¡¯ç¤ºå…·æœ‰æ•¸ä½ç°½ç« æˆ–ä¸å¯å¦èªèƒ½åŠ›çš„æ†‘è­‰)";
                }
                else if (operation == "encrypt")
                {
                    dialogTitle = "é¸æ“‡åŠ å¯†æ†‘è­‰";
                    dialogMessage = "è«‹é¸æ“‡è¦ç”¨æ–¼åŠ å¯†æ–‡ä»¶çš„æ†‘è­‰ (é¡¯ç¤ºæ‰€æœ‰å…·æœ‰å…¬é‘°çš„æ†‘è­‰)";
                }

                // ä½¿ç”¨X509Certificate2UIé¡åˆ¥å¾æ­£ç¢ºçš„å‘½åç©ºé–“
                X509Certificate2Collection selected = X509Certificate2UI.SelectFromCollection(
                    filteredCollection,
                    dialogTitle,
                    dialogMessage,
                    X509SelectionFlag.SingleSelection);

                if (selected.Count > 0)
                {
                    return new X509Certificate2(selected[0]);
                }
                else
                {
                    throw new Exception("æœªé¸æ“‡ä»»ä½•æ†‘è­‰ã€‚");
                }
            }
        }

        private static X509Certificate2 FindCertificate(string identifier, string operation = null)
        {
            // å¦‚æœæœªæä¾›è­˜åˆ¥ç¢¼ï¼Œé¡¯ç¤ºé¸æ“‡å°è©±æ¡†
            if (string.IsNullOrEmpty(identifier))
            {
                return SelectCertificateFromUI(operation);
            }

            Console.WriteLine($"æ­£åœ¨å°‹æ‰¾è­‰æ›¸: {identifier}");

            // å˜—è©¦å¾å€‹äººå­˜æ”¾å€å°‹æ‰¾è­‰æ›¸
            using (X509Store store = new X509Store(StoreName.My, StoreLocation.CurrentUser))
            {
                store.Open(OpenFlags.ReadOnly);

                // è™•ç†SHA1æŒ‡ç´‹ (ä¸å€åˆ†å¤§å°å¯«ä¸¦ç§»é™¤ç©ºæ ¼å’Œå†’è™Ÿ)
                string cleanIdentifier = identifier.Replace(" ", "").Replace(":", "").Replace("-", "").ToLowerInvariant();
                Console.WriteLine($"æ¸…ç†å¾Œçš„è­˜åˆ¥ç¢¼: {cleanIdentifier}");

                // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰å®Œå…¨åŒ¹é…çš„æŒ‡ç´‹
                foreach (X509Certificate2 cert in store.Certificates)
                {
                    if (cert.HasPrivateKey)
                    {
                        string thumbprint = cert.Thumbprint.Replace(" ", "").Replace(":", "").Replace("-", "").ToLowerInvariant();
                        
                        // åµéŒ¯è¼¸å‡º
                        Console.WriteLine($"æ¯”å°è­‰æ›¸: {cert.Subject}");
                        Console.WriteLine($"SHA1æŒ‡ç´‹: {thumbprint}");
                        
                        if (string.Equals(thumbprint, cleanIdentifier, StringComparison.OrdinalIgnoreCase))
                        {
                            Console.WriteLine("æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„SHA1æŒ‡ç´‹è­‰æ›¸!");
                            return new X509Certificate2(cert);
                        }
                    }
                }

                // å¦‚æœæ²’æœ‰æ‰¾åˆ°å®Œå…¨åŒ¹é…çš„æŒ‡ç´‹ï¼Œå˜—è©¦å…¶ä»–åŒ¹é…æ–¹å¼
                foreach (X509Certificate2 cert in store.Certificates)
                {
                    if (cert.HasPrivateKey)
                    {
                        if (cert.Subject.Contains(identifier) ||
                            cert.SerialNumber.Equals(identifier, StringComparison.OrdinalIgnoreCase))
                        {
                            Console.WriteLine($"æ‰¾åˆ°åŒ¹é…çš„è­‰æ›¸ (é€šéä¸»é¡Œæˆ–åºè™Ÿ): {cert.Subject}");
                            return new X509Certificate2(cert);
                        }
                    }
                }
            }

            // å¦‚æœæ‰¾ä¸åˆ°è­‰æ›¸ï¼Œå›åˆ°é¸æ“‡å°è©±æ¡†
            Console.WriteLine($"æ‰¾ä¸åˆ°ç¬¦åˆè­˜åˆ¥ç¢¼ '{identifier}' çš„æ†‘è­‰ï¼Œé–‹å•Ÿé¸æ“‡å°è©±æ¡†...");
            return SelectCertificateFromUI(operation);
        }

        private static void ListCertificates()
        {
            using (X509Store store = new X509Store(StoreName.My, StoreLocation.CurrentUser))
            {
                store.Open(OpenFlags.ReadOnly);
                
                Console.WriteLine("å¯ç”¨çš„æ†‘è­‰:");
                Console.WriteLine("---------------------------------------------------");
                bool foundAny = false;
                
                foreach (X509Certificate2 cert in store.Certificates)
                {
                    if (cert.HasPrivateKey)
                    {
                        foundAny = true;
                        Console.WriteLine($"ä¸»é¡Œ: {cert.Subject}");
                        Console.WriteLine($"ç™¼è¡Œè€…: {cert.Issuer}");
                        Console.WriteLine($"åºè™Ÿ: {cert.SerialNumber}");
                        Console.WriteLine($"SHA1æŒ‡ç´‹: {cert.Thumbprint}");
                        Console.WriteLine($"æœ‰æ•ˆæœŸ: {cert.NotBefore} è‡³ {cert.NotAfter}");
                        
                        // é¡¯ç¤ºæ˜¯å¦ç‚ºæ™ºæ…§å¡æ†‘è­‰
                        bool isSmartCard = IsSmartCardCertificate(cert);
                        Console.WriteLine($"æ™ºæ…§å¡æ†‘è­‰: {(isSmartCard ? "æ˜¯" : "å¦")}");
                        
                        Console.WriteLine("---------------------------------------------------");
                    }
                }
                
                if (!foundAny)
                {
                    Console.WriteLine("æœªæ‰¾åˆ°ä»»ä½•å…·æœ‰ç§é‘°çš„æ†‘è­‰ã€‚");
                }
            }
        }

        private static bool IsSmartCardCertificate(X509Certificate2 cert)
        {
            try
            {
                // é¦–å…ˆæª¢æŸ¥ CNG Key Storage Provider
                using (RSA rsa = cert.GetRSAPrivateKey())
                {
                    if (rsa is RSACng rsaCng)
                    {
                        string providerName = rsaCng.Key.Provider.ToString();
                        if (providerName.Contains("Smart Card"))
                        {
                            return true;
                        }
                    }
                }

                // å¦‚æœ CNG åˆ¤æ–·ä¸æ˜¯æ™ºæ…§å¡ï¼Œæª¢æŸ¥å…¶ä»–ç‰¹å¾µ
                
                // 1. æª¢æŸ¥æ“´å±•å±¬æ€§ï¼Œå°‹æ‰¾æ™ºæ…§å¡ç›¸é—œçš„OIDæˆ–æ¨™ç¤º
                foreach (var extension in cert.Extensions)
                {
                    // æŸäº›æ™ºæ…§å¡è­‰æ›¸å¯èƒ½æœ‰ç‰¹æ®Šçš„æ“´å±•
                    if (extension.Oid.Value == "1.3.6.1.4.1.311.20.2")  // Smart Card Logon OID
                    {
                        return true;
                    }
                }
                
                // 2. æª¢æŸ¥æ†‘è­‰ä¸»é¡Œæ˜¯å¦åŒ…å«æ™ºæ…§å¡ç›¸é—œè³‡è¨Š
                if (cert.Subject.Contains("Smart Card") || 
                    cert.Subject.Contains("SmartCard") || 
                    cert.Subject.Contains("PIV") ||
                    cert.Subject.ToLowerInvariant().Contains("card"))
                {
                    return true;
                }
                
                // 3. æª¢æŸ¥é ’ç™¼è€…æ˜¯å¦ç‚ºå·²çŸ¥çš„æ™ºæ…§å¡æ†‘è­‰é ’ç™¼è€…
                if (cert.Issuer.Contains("Smart Card") || 
                    cert.Issuer.Contains("PIV") ||
                    cert.Issuer.ToLowerInvariant().Contains("card"))
                {
                    return true;
                }
                
                // 4. æª¢æŸ¥å¢å¼·å‹é‡‘é‘°ä½¿ç”¨æ³•(EKU)æ˜¯å¦å«æ™ºæ…§å¡ç™»å…¥
                foreach (var extension in cert.Extensions)
                {
                    if (extension is X509EnhancedKeyUsageExtension eku)
                    {
                        foreach (var oid in eku.EnhancedKeyUsages)
                        {
                            // æ™ºæ…§å¡ç™»å…¥ OID
                            if (oid.Value == "1.3.6.1.4.1.311.20.2.2")
                            {
                                return true;
                            }
                        }
                    }
                }
                
                return false;
            }
            catch
            {
                return false;
            }
        }

        private static async Task HandleSignCommand(string[] args)
        {
            // è™•ç†ç°½åå‘½ä»¤
            // æª¢æŸ¥åƒæ•¸
            if (args.Length < 2)
            {
                Console.WriteLine("éŒ¯èª¤: æœªæŒ‡å®šæª”æ¡ˆ");
                PrintUsage();
                return;
            }
            
            // æŸ¥æ‰¾æª”æ¡ˆè·¯å¾‘
            string filePath = FindFilePath(args, 1);
            if (string.IsNullOrEmpty(filePath) || !File.Exists(filePath))
            {
                Console.WriteLine($"éŒ¯èª¤: æª”æ¡ˆ '{filePath}' ä¸å­˜åœ¨");
                return;
            }
            
            // æª¢æŸ¥æ˜¯å¦æŒ‡å®šè­‰æ›¸
            string certIdentifier = null;
            bool useTimestamp = false;
            string tsaUrl = null;
            string hashAlgorithm = "SHA384"; // é è¨­ä½¿ç”¨SHA384
            bool includeContent = false; // é è¨­ä¸åŒ…å«å…§å®¹
            
            for (int i = 1; i < args.Length; i++)
            {
                string arg = args[i].ToLower();
                
                if (arg.StartsWith("--cert=") || arg.StartsWith("-c="))
                {
                    certIdentifier = arg.Split('=')[1];
                }
                else if (arg.StartsWith("--sha1="))
                {
                    certIdentifier = arg.Split('=')[1];
                }
                else if (arg.StartsWith("--hash="))
                {
                    hashAlgorithm = arg.Split('=')[1].ToUpper();
                    // é©—è­‰é›œæ¹Šæ¼”ç®—æ³•æ˜¯å¦æ”¯æ´
                    if (!new[] { "SHA1", "SHA256", "SHA384", "SHA512" }.Contains(hashAlgorithm))
                    {
                        Console.WriteLine($"éŒ¯èª¤: ä¸æ”¯æ´çš„é›œæ¹Šæ¼”ç®—æ³• '{hashAlgorithm}'ï¼Œå°‡ä½¿ç”¨é è¨­å€¼ SHA384");
                        hashAlgorithm = "SHA384";
                    }
                }
                else if (arg == "--timestamp" || arg == "-t")
                {
                    useTimestamp = true;
                }
                else if (arg.StartsWith("--timestamp=") || arg.StartsWith("-t="))
                {
                    useTimestamp = true;
                    tsaUrl = arg.Split('=')[1];
                }
                else if (arg == "--include-content")
                {
                    includeContent = true;
                }
            }
            
            // ç°½ç½²æª”æ¡ˆ
            await SignFile(filePath, certIdentifier, useTimestamp, tsaUrl, hashAlgorithm, includeContent);
        }
        
        private static async Task HandleEncryptCommand(string[] args)
        {
            if (args.Length < 2)
            {
                Console.WriteLine("éŒ¯èª¤: åŠ å¯†å‘½ä»¤éœ€è¦æŒ‡å®šæª”æ¡ˆè·¯å¾‘");
                PrintUsage();
                return;
            }
            
            // æ‰¾å‡ºæª”æ¡ˆè·¯å¾‘ï¼ˆç¬¬ä¸€å€‹éåƒæ•¸é¸é …ï¼‰
            string filePath = FindFilePath(args, 1);
            if (filePath == null)
            {
                Console.WriteLine("éŒ¯èª¤: æœªæŒ‡å®šæœ‰æ•ˆçš„æª”æ¡ˆè·¯å¾‘");
                PrintUsage();
                return;
            }
            
            // æª¢æŸ¥æª”æ¡ˆæ˜¯å¦å­˜åœ¨
            if (!File.Exists(filePath))
            {
                Console.WriteLine($"éŒ¯èª¤: æ‰¾ä¸åˆ°æª”æ¡ˆ '{filePath}'");
                return;
            }
            
            string certIdentifier = null;
            string certFilePath = null;
            
            // è™•ç†åƒæ•¸
            for (int i = 1; i < args.Length; i++)
            {
                if (args[i].StartsWith("--cert="))
                {
                    certIdentifier = args[i].Substring("--cert=".Length);
                }
                else if (args[i].StartsWith("--sha1="))
                {
                    certIdentifier = args[i].Substring("--sha1=".Length);
                }
                else if (args[i].StartsWith("--cert-file="))
                {
                    certFilePath = args[i].Substring("--cert-file=".Length);
                }
            }
            
            // ä½¿ç”¨æ†‘è­‰æª”æ¡ˆåŠ å¯†
            if (!string.IsNullOrEmpty(certFilePath))
            {
                EncryptFileWithCertFile(filePath, certFilePath);
                return;
            }
            
            // ä½¿ç”¨æ†‘è­‰åŠ å¯†
            EncryptFile(filePath, certIdentifier);
        }
        
        // æ–°å¢è¼”åŠ©æ–¹æ³•ä¾†åœ¨åƒæ•¸åˆ—è¡¨ä¸­å°‹æ‰¾æª”æ¡ˆè·¯å¾‘
        private static string FindFilePath(string[] args, int startIndex)
        {
            // å°‹æ‰¾ç¬¬ä¸€å€‹ä¸æ˜¯åƒæ•¸çš„åƒæ•¸ï¼ˆå³ä¸æ˜¯ä»¥--é–‹é ­ï¼‰
            for (int i = startIndex; i < args.Length; i++)
            {
                if (!args[i].StartsWith("--"))
                {
                    // é€²è¡Œå®‰å…¨æ€§æª¢æŸ¥
                    string path = args[i];
                    
                    // æª¢æŸ¥è·¯å¾‘æ˜¯å¦æœ‰æ•ˆ
                    if (string.IsNullOrWhiteSpace(path))
                    {
                        Console.WriteLine("éŒ¯èª¤: æŒ‡å®šçš„æª”æ¡ˆè·¯å¾‘ç„¡æ•ˆ");
                        return null;
                    }
                    
                    // æª¢æŸ¥è·¯å¾‘æ˜¯å¦åŒ…å«ä¸å…è¨±çš„å­—ç¬¦
                    char[] invalidChars = Path.GetInvalidPathChars();
                    if (path.IndexOfAny(invalidChars) >= 0)
                    {
                        Console.WriteLine("éŒ¯èª¤: æª”æ¡ˆè·¯å¾‘åŒ…å«ç„¡æ•ˆå­—ç¬¦");
                        return null;
                    }
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºçµ•å°è·¯å¾‘æˆ–ç›¸å°è·¯å¾‘
                    if (!Path.IsPathRooted(path))
                    {
                        path = Path.GetFullPath(path);
                    }
                    
                    return path;
                }
            }
            
            return null;
        }

        private static async Task SignFile(string filePath, string certIdentifier, bool useTimestamp, string tsaUrl, string hashAlgorithm, bool includeContent)
        {
            try
            {
                // è®€å–è¦ç°½åçš„æ–‡ä»¶
                byte[] fileContent = File.ReadAllBytes(filePath);
                
                // æŸ¥æ‰¾æŒ‡å®šçš„è­‰æ›¸
                X509Certificate2 certificate = null;
                if (string.IsNullOrEmpty(certIdentifier))
                {
                    certificate = SelectCertificateFromUI("sign");
                    if (certificate == null)
                    {
                        Console.WriteLine("æœªé¸æ“‡è­‰æ›¸ï¼Œç°½åå·²å–æ¶ˆ");
                        return;
                    }
                }
                else
                {
                    // ç›´æ¥æŸ¥æ‰¾è­‰æ›¸ï¼Œæ‰¾ä¸åˆ°æ‰é¡¯ç¤ºé¸æ“‡å°è©±æ¡†
                    certificate = FindCertificateDirectly(certIdentifier);
                    if (certificate == null)
                    {
                        Console.WriteLine($"æ‰¾ä¸åˆ°ç¬¦åˆ '{certIdentifier}' çš„è­‰æ›¸ï¼Œé–‹å•Ÿé¸æ“‡å°è©±æ¡†...");
                        certificate = SelectCertificateFromUI("sign");
                        if (certificate == null)
                        {
                            Console.WriteLine("æœªé¸æ“‡è­‰æ›¸ï¼Œç°½åå·²å–æ¶ˆ");
                            return;
                        }
                    }
                }
                
                Console.WriteLine($"ä½¿ç”¨è­‰æ›¸: {certificate.Subject}");
                Console.WriteLine($"æ™ºæ…§å¡æ†‘è­‰: {(IsSmartCardCertificate(certificate) ? "æ˜¯" : "å¦")}");
                Console.WriteLine($"æ­£åœ¨ç°½ç½²æª”æ¡ˆ: {Path.GetFileName(filePath)}");
                Console.WriteLine($"ä½¿ç”¨é›œæ¹Šæ¼”ç®—æ³•: {hashAlgorithm}");
                Console.WriteLine($"åŒ…å«æª”æ¡ˆå…§å®¹: {(includeContent ? "æ˜¯" : "å¦")}");
                
                // å»ºç«‹CMSç°½å
                ContentInfo contentInfo = new ContentInfo(fileContent);
                SignedCms signedCms = new SignedCms(contentInfo, !includeContent); // detached = !includeContent
                
                // å‰µå»ºç°½åè€…ä¿¡æ¯
                CmsSigner signer = new CmsSigner(certificate);
                signer.IncludeOption = X509IncludeOption.EndCertOnly;
                
                // è¨­å®šé›œæ¹Šæ¼”ç®—æ³•
                switch (hashAlgorithm)
                {
                    case "SHA1":
                        signer.DigestAlgorithm = new Oid("1.3.14.3.2.26"); // SHA1
                        break;
                    case "SHA256":
                        signer.DigestAlgorithm = new Oid("2.16.840.1.101.3.4.2.1"); // SHA256
                        break;
                    case "SHA384":
                        signer.DigestAlgorithm = new Oid("2.16.840.1.101.3.4.2.2"); // SHA384
                        break;
                    case "SHA512":
                        signer.DigestAlgorithm = new Oid("2.16.840.1.101.3.4.2.3"); // SHA512
                        break;
                    default:
                        // ä½¿ç”¨é è¨­
                        signer.DigestAlgorithm = new Oid("2.16.840.1.101.3.4.2.2"); // SHA384
                        break;
                }
                
                // ç°½ç½²æª”æ¡ˆ
                signedCms.ComputeSignature(signer);
                byte[] signature = signedCms.Encode();
                
                // å¦‚æœéœ€è¦ï¼Œæ·»åŠ æ™‚é–“æˆ³è¨˜
                if (useTimestamp)
                {
                    signature = await AddTimestamp(signature, tsaUrl, hashAlgorithm);
                }
                
                // æ ¹æ“šæ˜¯å¦åŒ…å«å…§å®¹æ±ºå®šå„²å­˜çš„å‰¯æª”å
                string extension = includeContent ? ".p7m" : ".p7s";
                string outputPath = filePath + extension;
                File.WriteAllBytes(outputPath, signature);
                Console.WriteLine($"å·²ç°½ç½²æª”æ¡ˆä¸¦å­˜å„²ç‚º: {outputPath}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ç°½åå¤±æ•—: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"è©³ç´°éŒ¯èª¤: {ex.InnerException.Message}");
                }
            }
        }
        
        private static async Task<byte[]> AddTimestamp(byte[] signature, string tsaUrl, string hashAlgorithm)
        {
            if (string.IsNullOrEmpty(tsaUrl))
            {
                // å¦‚æœæœªæŒ‡å®šæ™‚é–“æˆ³è¨˜ä¼ºæœå™¨ï¼Œå‰‡ä½¿ç”¨é è¨­ä¼ºæœå™¨
                tsaUrl = "http://timestamp.digicert.com";
            }

            Console.WriteLine($"ä½¿ç”¨æ™‚é–“æˆ³è¨˜ä¼ºæœå™¨: {tsaUrl}");

            try
            {
                // è¨ˆç®—ç°½ç« çš„é›œæ¹Šå€¼
                byte[] hash;
                
                // æ ¹æ“šæŒ‡å®šçš„é›œæ¹Šæ¼”ç®—æ³•å»ºç«‹å°æ‡‰çš„é›œæ¹Šç‰©ä»¶
                using (HashAlgorithm hasher = CreateHashAlgorithm(hashAlgorithm))
                {
                    hash = hasher.ComputeHash(signature);
                }

                // ä½¿ç”¨ BouncyCastle å»ºç«‹æ™‚é–“æˆ³è¨˜è«‹æ±‚
                TimeStampRequestGenerator requestGenerator = new TimeStampRequestGenerator();
                requestGenerator.SetCertReq(true);

                // è¨­å®šé›œæ¹Šæ¼”ç®—æ³•çš„OID
                string hashOid = GetHashAlgorithmOid(hashAlgorithm);
                TimeStampRequest request = requestGenerator.Generate(hashOid, hash);
                byte[] requestBytes = request.GetEncoded();

                Console.WriteLine("æ­£åœ¨å‘æ™‚é–“æˆ³è¨˜ä¼ºæœå™¨ç™¼é€è«‹æ±‚...");
                Console.WriteLine($"æ™‚é–“æˆ³è¨˜è«‹æ±‚å¤§å°: {requestBytes.Length} å­—ç¯€");
                Console.WriteLine($"é›œæ¹Šæ¼”ç®—æ³•: {hashAlgorithm}");

                // ç™¼é€æ™‚é–“æˆ³è¨˜è«‹æ±‚
                HttpClient client = new HttpClient();
                
                // å»ºç«‹åŒ…å«äºŒé€²åˆ¶å…§å®¹çš„HttpContent
                ByteArrayContent content = new ByteArrayContent(requestBytes);
                content.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/timestamp-query");
                
                // å‚³é€è«‹æ±‚åˆ°æ™‚é–“æˆ³è¨˜ä¼ºæœå™¨
                HttpResponseMessage response = await client.PostAsync(tsaUrl, content);
                
                if (response.IsSuccessStatusCode)
                {
                    byte[] tsResponse = await response.Content.ReadAsByteArrayAsync();
                    Console.WriteLine($"å·²æ”¶åˆ°æ™‚é–“æˆ³è¨˜å›æ‡‰ï¼Œå¤§å°: {tsResponse.Length} ä½å…ƒçµ„");

                    if (tsResponse == null || tsResponse.Length == 0)
                    {
                        Console.WriteLine("éŒ¯èª¤ï¼šå¾æ™‚é–“æˆ³è¨˜ä¼ºæœå™¨æ”¶åˆ°ç©ºå›æ‡‰");
                        return signature;
                    }

                    // é¦–å…ˆå˜—è©¦ç”¨RFC 3161æ¨™æº–è™•ç†æ™‚é–“æˆ³è¨˜
                    try
                    {
                        // è§£ææ™‚é–“æˆ³è¨˜å›æ‡‰
                        TimeStampResponse tsResp = new TimeStampResponse(tsResponse);
                        TimeStampToken tsToken = tsResp.TimeStampToken;

                        if (tsToken == null)
                        {
                            Console.WriteLine("ç„¡æ³•å¾å›æ‡‰ä¸­ç²å–æ™‚é–“æˆ³è¨˜ä»¤ç‰Œï¼Œå°‡å˜—è©¦å…¶ä»–æ ¼å¼");
                            // å¦‚æœRFC 3161è™•ç†å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–æ ¼å¼
                            return AddOtherTimestamp(signature, tsResponse);
                        }

                        // æå–æ™‚é–“æˆ³è¨˜è³‡è¨Š
                        DateTime timestampTime = tsToken.TimeStampInfo.GenTime;
                        Console.WriteLine($"æ™‚é–“æˆ³è¨˜æ™‚é–“ (UTC): {timestampTime.ToUniversalTime():yyyy-MM-dd HH:mm:ss} UTC");
                        Console.WriteLine($"æ™‚é–“æˆ³è¨˜æ™‚é–“ (æœ¬åœ°): {timestampTime.ToLocalTime():yyyy-MM-dd HH:mm:ss} {TimeZoneInfo.Local.DisplayName}");

                        // å¾TimeStampTokenæå–DERç·¨ç¢¼
                        byte[] tokenBytes = tsToken.GetEncoded();
                        
                        // å»ºç«‹SignedCmsç‰©ä»¶
                        SignedCms signedCms = new SignedCms();
                        signedCms.Decode(signature);
                        
                        // ç²å–ç°½åè€…ä¸¦æ·»åŠ æ™‚é–“æˆ³è¨˜
                        SignerInfo signer = signedCms.SignerInfos[0];
                        
                        // å»ºç«‹RFC 3161æ™‚é–“æˆ³è¨˜å±¬æ€§
                        Oid timestampOid = new Oid("1.2.840.113549.1.9.16.2.14"); // RFC 3161 OID
                        AsnEncodedData timestampAttribute = new AsnEncodedData(timestampOid, tokenBytes);
                        signer.AddUnsignedAttribute(timestampAttribute);
                        
                        Console.WriteLine("RFC 3161æ™‚é–“æˆ³è¨˜å·²æ·»åŠ åˆ°ç°½ç« ä¸­");
                        return signedCms.Encode();
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"RFC 3161æ™‚é–“æˆ³è¨˜è™•ç†å¤±æ•—: {ex.Message}");
                        Console.WriteLine("å˜—è©¦ä½¿ç”¨å…¶ä»–æ ¼å¼...");
                        // å¦‚æœRFC 3161è™•ç†å¤±æ•—ï¼Œå˜—è©¦å…¶ä»–æ ¼å¼
                        return AddOtherTimestamp(signature, tsResponse);
                    }
                }
                else
                {
                    // å¦‚æœè«‹æ±‚å¤±æ•—ï¼Œé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
                    Console.WriteLine($"æ™‚é–“æˆ³è¨˜è«‹æ±‚å¤±æ•—: {response.StatusCode} {response.ReasonPhrase}");
                    return signature;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"æ™‚é–“æˆ³è¨˜è™•ç†å‡ºéŒ¯: {ex.Message}");
                return signature;
            }
        }

        // ç”¨æ–¼è™•ç†å…¶ä»–æ ¼å¼æ™‚é–“æˆ³è¨˜çš„æ–¹æ³•
        private static byte[] AddOtherTimestamp(byte[] signature, byte[] tsResponse)
        {
            try
            {
                Console.WriteLine("ä½¿ç”¨å…¶ä»–OIDè™•ç†æ™‚é–“æˆ³è¨˜...");
                
                // å»ºç«‹SignedCmsç‰©ä»¶
                SignedCms signedCms = new SignedCms();
                signedCms.Decode(signature);
                
                // ç²å–ç°½åè€…
                SignerInfo signer = signedCms.SignerInfos[0];
                
                // å…¶ä»–æ™‚é–“æˆ³è¨˜ä½¿ç”¨çš„OID
                Oid msTimestampOid = new Oid("1.3.6.1.4.1.311.3.3.1");
                
                // å»ºç«‹æ™‚é–“æˆ³è¨˜å±¬æ€§
                AsnEncodedData msTimestampAttribute = new AsnEncodedData(msTimestampOid, tsResponse);
                signer.AddUnsignedAttribute(msTimestampAttribute);
                
                Console.WriteLine("å…¶ä»–æ ¼å¼æ™‚é–“æˆ³è¨˜å·²æ·»åŠ åˆ°ç°½ç« ä¸­");
                return signedCms.Encode();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"å…¶ä»–æ™‚é–“æˆ³è¨˜è™•ç†å¤±æ•—: {ex.Message}");
                return signature;
            }
        }

        private static void VerifySignature(string filePath, bool extractContent = false)
        {
            try
            {
                // æª¢æŸ¥æª”æ¡ˆå‰¯æª”åï¼Œåˆ¤æ–·é¡å‹
                bool isP7mFile = filePath.EndsWith(".p7m", StringComparison.OrdinalIgnoreCase);
                bool isP7sFile = filePath.EndsWith(".p7s", StringComparison.OrdinalIgnoreCase);
                
                if (!isP7mFile && !isP7sFile)
                {
                    Console.WriteLine($"è­¦å‘Š: æª”æ¡ˆ '{filePath}' æ²’æœ‰æ¨™æº–çš„ç°½ç« å‰¯æª”å (.p7s æˆ– .p7m)");
                }
                
                // è®€å–ç°½ç« æª”æ¡ˆå…§å®¹
                byte[] signatureBytes = File.ReadAllBytes(filePath);
                Console.WriteLine($"å·²è®€å–äºŒé€²åˆ¶æª”æ¡ˆ ({signatureBytes.Length} å­—ç¯€)");
                
                // æª¢æŸ¥å°æ‡‰çš„åŸå§‹æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                string originalFilePath = null;
                if (isP7sFile)
                {
                    // å°æ–¼.p7sæª”æ¡ˆï¼ŒåŸå§‹æª”æ¡ˆæ‡‰è©²æ˜¯å»æ‰.p7sçš„æª”æ¡ˆ
                    originalFilePath = filePath.Substring(0, filePath.Length - 4);
                }
                else if (isP7mFile)
                {
                    // å°æ–¼.p7mæª”æ¡ˆï¼Œé¦–å…ˆè¦åˆ¤æ–·å®ƒæ˜¯åŠ å¯†æª”æ¡ˆé‚„æ˜¯åŒ…å«å…§å®¹çš„ç°½ç« 
                    try
                    {
                        // å˜—è©¦ç•¶ä½œEnvelopedCmsè§£ç¢¼
                        EnvelopedCms envelopedCms = new EnvelopedCms();
                        envelopedCms.Decode(signatureBytes);
                        
                        // å¦‚æœè§£ç¢¼æˆåŠŸä½†æ²’æœ‰æ‹‹å‡ºç•°å¸¸ï¼Œå‰‡å¯èƒ½æ˜¯åŠ å¯†æª”æ¡ˆè€Œéç°½ç« 
                        Console.WriteLine("éŒ¯èª¤: æŒ‡å®šçš„æª”æ¡ˆä¼¼ä¹æ˜¯åŠ å¯†æª”æ¡ˆ (.p7m)ï¼Œè€Œéç°½ç« æª”æ¡ˆ (.p7s)");
                        Console.WriteLine("è«‹ä½¿ç”¨ 'decrypt' å‘½ä»¤ä¾†è§£å¯†è©²æª”æ¡ˆï¼Œæˆ–æª¢æŸ¥æ‚¨æ˜¯å¦æä¾›äº†æ­£ç¢ºçš„æª”æ¡ˆ");
                        return;
                    }
                    catch
                    {
                        // å¦‚æœEnvelopedCmsè§£ç¢¼å¤±æ•—ï¼Œå¯èƒ½æ˜¯éåˆ†é›¢å¼ç°½ç« 
                        try
                        {
                            SignedCms checkCms = new SignedCms();
                            checkCms.Decode(signatureBytes);
                            
                            // æª¢æŸ¥æ˜¯å¦åŒ…å«å…§å®¹
                            bool hasContent = checkCms.ContentInfo.Content != null && checkCms.ContentInfo.Content.Length > 0;
                            if (hasContent)
                            {
                                Console.WriteLine("æª”æ¡ˆåŒ…å«å…§å®¹çš„éåˆ†é›¢å¼ç°½ç«  (.p7m)");
                                // ä¸éœ€è¦åŸå§‹æª”æ¡ˆï¼Œå› ç‚ºå…§å®¹åŒ…å«åœ¨ç°½ç« ä¸­
                                originalFilePath = null;
                            }
                            else
                            {
                                // å¯èƒ½æ˜¯åˆ†é›¢å¼ç°½ç« ä½†ä½¿ç”¨äº†.p7må‰¯æª”å
                                originalFilePath = filePath.Substring(0, filePath.Length - 4);
                                Console.WriteLine($"è­¦å‘Š: æª”æ¡ˆä½¿ç”¨äº†.p7må‰¯æª”åä½†ä¼¼ä¹æ˜¯åˆ†é›¢å¼ç°½ç« ï¼Œå˜—è©¦ä½¿ç”¨åŸå§‹æª”æ¡ˆ: {originalFilePath}");
                            }
                        }
                        catch
                        {
                            // å¦‚æœSignedCmsè§£ç¢¼ä¹Ÿå¤±æ•—ï¼Œå‰‡å¯èƒ½æ˜¯ç„¡æ•ˆæˆ–æå£çš„æª”æ¡ˆ
                            Console.WriteLine("éŒ¯èª¤: ç„¡æ³•è§£ææª”æ¡ˆæ ¼å¼ï¼Œæ—¢ä¸æ˜¯æœ‰æ•ˆçš„åŠ å¯†æª”æ¡ˆä¹Ÿä¸æ˜¯æœ‰æ•ˆçš„ç°½ç« æª”æ¡ˆ");
                            return;
                        }
                    }
                }
                
                // æª¢æŸ¥å°æ‡‰çš„åŸå§‹æª”æ¡ˆæ˜¯å¦å­˜åœ¨
                if (originalFilePath != null)
                {
                    if (!File.Exists(originalFilePath))
                    {
                        Console.WriteLine($"è­¦å‘Š: æ‰¾ä¸åˆ°åŸå§‹æª”æ¡ˆ '{originalFilePath}' ï¼Œå°‡å˜—è©¦ç›´æ¥è§£æç°½å");
                    }
                    else
                    {
                        Console.WriteLine($"å·²æ‰¾åˆ°åŸå§‹æª”æ¡ˆ: {originalFilePath}");
                    }
                }
                
                // æº–å‚™è§£ç¢¼ç°½ç« 
                SignedCms signedCms = new SignedCms();
                bool hasEmbeddedContent = false;
                bool verificationSucceeded = false;
                bool fileMatchesSignature = false; // æ–°å¢æ¨™è¨˜ï¼Œè¡¨ç¤ºæª”æ¡ˆå…§å®¹æ˜¯å¦èˆ‡ç°½ç« åŒ¹é…
                
                if (_debugMode)
                {
                    Console.WriteLine("æ­£åœ¨é©—è­‰ç°½ç« ...");
                }
                
                // å¤šç¨®é©—è­‰å˜—è©¦
                // é¦–å…ˆï¼Œå˜—è©¦éåˆ†é›¢å¼ç°½ç« è§£ç¢¼
                try
                {
                    DebugLog("å˜—è©¦éåˆ†é›¢å¼ç°½ç« è§£ç¢¼...");
                    signedCms.Decode(signatureBytes);
                    
                    // æª¢æŸ¥æ˜¯å¦åŒ…å«å…§å®¹
                    hasEmbeddedContent = signedCms.ContentInfo.Content != null && signedCms.ContentInfo.Content.Length > 0;
                    
                    if (hasEmbeddedContent)
                    {
                        try
                        {
                            // å˜—è©¦ç›´æ¥é©—è­‰åŒ…å«å…§å®¹çš„ç°½ç« 
                            signedCms.CheckSignature(true);
                            verificationSucceeded = true;
                            fileMatchesSignature = true;
                            Console.WriteLine("éåˆ†é›¢å¼ç°½ç« é©—è­‰æˆåŠŸ");
                        }
                        catch (Exception ex)
                        {
                            DebugLog($"éåˆ†é›¢å¼ç°½ç« é©—è­‰å¤±æ•—: {ex.Message}");
                            
                            // å˜—è©¦å¯¬å®¹æ¨¡å¼
                            try
                            {
                                signedCms.CheckSignature(false);
                                // å¯¬å®¹æ¨¡å¼æˆåŠŸï¼Œä½†æˆ‘å€‘ä¸å°‡å…¶è¦–ç‚ºå®Œå…¨é©—è­‰æˆåŠŸ
                                DebugLog("å¯¬å®¹æ¨¡å¼é©—è­‰éƒ¨åˆ†æˆåŠŸï¼Œæª”æ¡ˆå…§å®¹å¯èƒ½å·²è¢«ä¿®æ”¹");
                            }
                            catch
                            {
                                DebugLog("å¯¬å®¹æ¨¡å¼é©—è­‰ä¹Ÿå¤±æ•—");
                            }
                        }
                    }
                    else if (originalFilePath != null && File.Exists(originalFilePath))
                    {
                        // å¦‚æœç°½ç« ä¸åŒ…å«å…§å®¹ä½†æ‰¾åˆ°äº†åŸå§‹æª”æ¡ˆï¼Œå˜—è©¦åˆ†é›¢å¼ç°½ç« é©—è­‰
                        byte[] contentBytes = File.ReadAllBytes(originalFilePath);
                        
                        try
                        {
                            // æ–¹æ³• 1: æ¨™æº–åˆ†é›¢å¼ç°½å (é‡æ–°å‰µå»ºSignedCms)
                            DebugLog("å˜—è©¦æ¨™æº–åˆ†é›¢å¼ç°½åé©—è­‰æ–¹æ³•...");
                            ContentInfo contentInfo = new ContentInfo(contentBytes);
                            SignedCms standardCms = new SignedCms(contentInfo, true); // detached = true
                            standardCms.Decode(signatureBytes);
                            
                            try
                            {
                                standardCms.CheckSignature(true);
                                signedCms = standardCms;
                                verificationSucceeded = true;
                                fileMatchesSignature = true;
                                Console.WriteLine("ä½¿ç”¨æ¨™æº–åˆ†é›¢å¼ç°½åæ–¹æ³•é©—è­‰æˆåŠŸ");
                            }
                            catch (Exception standardEx)
                            {
                                DebugLog($"æ¨™æº–ç°½åæª¢æŸ¥å¤±æ•—: {standardEx.Message}");
                                
                                // å˜—è©¦å¯¬å®¹æª¢æŸ¥
                                try
                                {
                                    standardCms.CheckSignature(false);
                                    signedCms = standardCms;
                                    // å¯¬å®¹æ¨¡å¼æˆåŠŸï¼Œä½†æˆ‘å€‘ä¸å°‡å…¶è¦–ç‚ºå®Œå…¨é©—è­‰æˆåŠŸ
                                    DebugLog("å¯¬å®¹æ¨¡å¼é©—è­‰éƒ¨åˆ†æˆåŠŸï¼Œæª”æ¡ˆå…§å®¹å¯èƒ½å·²è¢«ä¿®æ”¹");
                                }
                                catch
                                {
                                    DebugLog("å¯¬å®¹æ¨¡å¼é©—è­‰ä¹Ÿå¤±æ•—");
                                }
                            }
                        }
                        catch (Exception ex1)
                        {
                            DebugLog($"æ¨™æº–åˆ†é›¢å¼ç°½åé©—è­‰å¤±æ•—: {ex1.Message}");
                            
                            // æ–¹æ³• 2: å˜—è©¦åå°„æ–¹å¼è¨­ç½®å…§å®¹
                            try
                            {
                                DebugLog("å˜—è©¦ä½¿ç”¨åå°„æ–¹å¼è¨­ç½®å…§å®¹...");
                                PrivateSetContentMethod(signedCms, contentBytes);
                                
                                try
                                {
                                    signedCms.CheckSignature(true);
                                    verificationSucceeded = true;
                                    fileMatchesSignature = true;
                                    Console.WriteLine("ä½¿ç”¨åå°„è¨­ç½®å…§å®¹æ–¹æ³•é©—è­‰æˆåŠŸ");
                                }
                                catch (Exception reflectEx)
                                {
                                    DebugLog($"åå°„è¨­ç½®å…§å®¹é©—è­‰å¤±æ•—: {reflectEx.Message}");
                                }
                            }
                            catch (Exception ex2)
                            {
                                DebugLog($"åå°„è¨­ç½®å…§å®¹æ–¹æ³•å¤±æ•—: {ex2.Message}");
                            }
                        }
                    }
                }
                catch (Exception decodeEx)
                {
                    DebugLog($"ç°½ç« è§£ç¢¼å¤±æ•—: {decodeEx.Message}");
                    Console.WriteLine("ç„¡æ³•è§£æç°½ç« æ•¸æ“šï¼Œæª”æ¡ˆå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ç°½ç« æª”æ¡ˆ");
                    return;
                }
                
                // æª¢æŸ¥signedCmsæ˜¯å¦å·²åˆå§‹åŒ–ä¸”æœ‰ç°½åè€…ä¿¡æ¯
                if (signedCms.SignerInfos.Count > 0)
                {
                    // æ›´æ–°hasEmbeddedContentæ¨™è¨˜
                    hasEmbeddedContent = signedCms.ContentInfo.Content != null && signedCms.ContentInfo.Content.Length > 0;
                    Console.WriteLine($"ç°½ç« åŒ…å«æª”æ¡ˆå…§å®¹: {(hasEmbeddedContent ? "æ˜¯" : "å¦")}");
                    
                    // å¦‚æœè¦æ±‚æå–å…§å®¹ä¸”ç°½ç« åŒ…å«å…§å®¹
                    if (extractContent && hasEmbeddedContent)
                    {
                        byte[] content = signedCms.ContentInfo.Content;
                        ExtractContentToFile(content, filePath);
                    }
                    
                    // é¡¯ç¤ºç°½ç« ä¿¡æ¯
                    DisplaySignatureInfo(signedCms);
                    
                    // æ ¹æ“šé©—è­‰çµæœé¡¯ç¤ºç›¸æ‡‰è¨Šæ¯
                    if (verificationSucceeded && fileMatchesSignature)
                    {
                        Console.WriteLine("ç°½ç« é©—è­‰æˆåŠŸ!");
                    }
                    else
                    {
                        Console.WriteLine("ç°½ç« é©—è­‰å¤±æ•—");
                        // æä¾›æ›´å…·é«”çš„éŒ¯èª¤åŸå› 
                        if (signedCms.SignerInfos.Count > 0 && signedCms.SignerInfos[0].Certificate != null)
                        {
                            Console.WriteLine("å¯èƒ½åŸå› : æª”æ¡ˆå…§å®¹èˆ‡ç°½ç« ä¸åŒ¹é…æˆ–ç°½ç« å·²æå£");
                        }
                        
                        if (!_debugMode)
                        {
                            Console.WriteLine("å¦‚éœ€æŸ¥çœ‹è©³ç´°éŒ¯èª¤è¨ºæ–·ï¼Œè«‹ä½¿ç”¨ --debug åƒæ•¸");
                        }
                    }
                }
                else
                {
                    Console.WriteLine("ç°½ç« ä¸åŒ…å«ä»»ä½•ç°½åè€…ä¿¡æ¯");
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"è™•ç†ç°½ç« æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
                if (ex.InnerException != null && _debugMode)
                {
                    Console.WriteLine($"å…§éƒ¨éŒ¯èª¤: {ex.InnerException.Message}");
                }
            }
        }
        
        // è¼”åŠ©æ–¹æ³•ï¼šæå–å…§å®¹åˆ°æª”æ¡ˆ
        private static void ExtractContentToFile(byte[] content, string signatureFilePath)
        {
            try
            {
                // ç”Ÿæˆè¼¸å‡ºæª”æ¡ˆåç¨±ï¼Œç§»é™¤å‰¯æª”å
                string outputFileName = null;
                
                if (signatureFilePath.EndsWith(".p7s", StringComparison.OrdinalIgnoreCase))
                {
                    outputFileName = signatureFilePath.Substring(0, signatureFilePath.Length - 4) + ".extracted";
                }
                else if (signatureFilePath.EndsWith(".p7m", StringComparison.OrdinalIgnoreCase))
                {
                    outputFileName = signatureFilePath.Substring(0, signatureFilePath.Length - 4) + ".extracted";
                }
                else
                {
                    outputFileName = signatureFilePath + ".extracted";
                }
                
                // æª¢æŸ¥è¼¸å‡ºè·¯å¾‘æ˜¯å¦èˆ‡åŸå§‹æª”æ¡ˆç›¸åŒ
                string originalFilePath = signatureFilePath;
                if (signatureFilePath.EndsWith(".p7s", StringComparison.OrdinalIgnoreCase) ||
                    signatureFilePath.EndsWith(".p7m", StringComparison.OrdinalIgnoreCase))
                {
                    originalFilePath = signatureFilePath.Substring(0, signatureFilePath.Length - 4);
                }
                
                // å¦‚æœåŸå§‹æª”æ¡ˆå­˜åœ¨ï¼Œæª¢æŸ¥å…§å®¹æ˜¯å¦ç›¸åŒ
                if (File.Exists(originalFilePath))
                {
                    try
                    {
                        byte[] originalContent = File.ReadAllBytes(originalFilePath);
                        if (content.SequenceEqual(originalContent))
                        {
                            Console.WriteLine($"æå–çš„å…§å®¹èˆ‡åŸå§‹æª”æ¡ˆ '{originalFilePath}' å…§å®¹å®Œå…¨ä¸€è‡´ï¼Œç„¡éœ€å¦å­˜");
                            return; // ä¸éœ€è¦ä¿å­˜ç›¸åŒçš„å…§å®¹
                        }
                    }
                    catch (Exception ex)
                    {
                        Console.WriteLine($"æ¯”è¼ƒæª”æ¡ˆå…§å®¹æ™‚å‡ºéŒ¯: {ex.Message}");
                    }
                }
                
                // å¯«å…¥æª”æ¡ˆå‰æª¢æŸ¥æ˜¯å¦æª”æ¡ˆå·²å­˜åœ¨
                if (File.Exists(outputFileName))
                {
                    Console.WriteLine($"è¼¸å‡ºæª”æ¡ˆ '{outputFileName}' å·²å­˜åœ¨ï¼Œå°‡è¦†è“‹");
                }
                
                // å¯«å…¥æª”æ¡ˆ
                File.WriteAllBytes(outputFileName, content);
                Console.WriteLine($"å·²æå–ç°½ç« å…§å®¹è‡³æª”æ¡ˆ: {outputFileName}");
                
                // å˜—è©¦åˆ¤æ–·æª”æ¡ˆé¡å‹
                TryDetermineFileType(outputFileName, content);
            }
            catch (Exception ex)
            {
                Console.WriteLine($"æå–å…§å®¹åˆ°æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
            }
        }
        
        // å˜—è©¦åˆ¤æ–·æª”æ¡ˆé¡å‹
        private static void TryDetermineFileType(string outputFileName, byte[] content)
        {
            try
            {
                // æª¢æŸ¥æª”æ¡ˆé ­éƒ¨ç‰¹å¾µä»¥åˆ¤æ–·æª”æ¡ˆé¡å‹
                if (content.Length < 8) return; // å¤ªå°çš„æª”æ¡ˆç„¡æ³•åˆ¤æ–·
                
                // æ–‡å­—æª”æ¡ˆç‰¹å¾µ
                bool isTextFile = true;
                foreach (byte b in content.Take(Math.Min(content.Length, 1024)))
                {
                    // æª¢æŸ¥éASCIIå’Œæ§åˆ¶å­—ç¬¦
                    if ((b < 32 || b > 126) && b != 9 && b != 10 && b != 13)
                    {
                        isTextFile = false;
                        break;
                    }
                }
                
                if (isTextFile)
                {
                    Console.WriteLine("æå–çš„å…§å®¹å¯èƒ½æ˜¯æ–‡å­—æª”æ¡ˆ");
                    return;
                }
                
                // å¸¸è¦‹æª”æ¡ˆé¡å‹ç‰¹å¾µ
                if (content[0] == 0x25 && content[1] == 0x50 && content[2] == 0x44 && content[3] == 0x46) // %PDF
                {
                    Console.WriteLine("æå–çš„å…§å®¹ç‚ºPDFæª”æ¡ˆ");
                }
                else if (content[0] == 0x50 && content[1] == 0x4B && content[2] == 0x03 && content[3] == 0x04) // PK..
                {
                    Console.WriteLine("æå–çš„å…§å®¹å¯èƒ½æ˜¯ZIP/Officeæª”æ¡ˆ");
                }
                else if (content[0] == 0xFF && content[1] == 0xD8 && content[2] == 0xFF) // JPEG
                {
                    Console.WriteLine("æå–çš„å…§å®¹ç‚ºJPEGåœ–ç‰‡");
                }
                else if (content[0] == 0x89 && content[1] == 0x50 && content[2] == 0x4E && content[3] == 0x47) // .PNG
                {
                    Console.WriteLine("æå–çš„å…§å®¹ç‚ºPNGåœ–ç‰‡");
                }
                else if (content[0] == 0x47 && content[1] == 0x49 && content[2] == 0x46 && content[3] == 0x38) // GIF8
                {
                    Console.WriteLine("æå–çš„å…§å®¹ç‚ºGIFåœ–ç‰‡");
                }
                else
                {
                    Console.WriteLine("æª”æ¡ˆé¡å‹åˆ¤æ–·: æœªçŸ¥æˆ–äºŒé€²åˆ¶æª”æ¡ˆ");
                }
            }
            catch (Exception ex)
            {
                DebugLog($"åˆ¤æ–·æª”æ¡ˆé¡å‹æ™‚å‡ºéŒ¯: {ex.Message}");
            }
        }
        
        // è¼”åŠ©æ–¹æ³•ï¼šå˜—è©¦å°‡å…§å®¹é¡¯ç¤ºç‚ºæ–‡å­—ï¼ˆä¿ç•™ä½†é‡å®šå‘åˆ°æ–°æ–¹æ³•ï¼‰
        private static void TryDisplayContent(byte[] content)
        {
            // æ­¤æ–¹æ³•ä¸å†ç”¨æ–¼é¡¯ç¤ºå…§å®¹ï¼Œè€Œæ˜¯é‡å®šå‘åˆ°æå–å…§å®¹çš„æ–¹æ³•
            // ä½¿ç”¨è‡¨æ™‚æª”æ¡ˆåï¼Œå¯¦éš›ä¸Šåœ¨æ­¤æ–¹æ³•èª¿ç”¨ä¸­æ²’æœ‰ä½¿ç”¨è©²åƒæ•¸
            ExtractContentToFile(content, "content");
        }
        
        // è¼”åŠ©æ–¹æ³•ï¼šé¡¯ç¤ºç°½ç« ä¿¡æ¯
        private static void DisplaySignatureInfo(SignedCms signedCms)
        {
                    if (signedCms.SignerInfos.Count > 0)
                    {
                        SignerInfo signer = signedCms.SignerInfos[0];
                        X509Certificate2 signerCert = signer.Certificate;
                        
                        if (signerCert != null)
                        {
                            Console.WriteLine($"ç°½ç½²è€…: {signerCert.Subject}");
                            Console.WriteLine($"è­‰æ›¸æŒ‡ç´‹: {BitConverter.ToString(signerCert.GetCertHash()).Replace("-", "")}");
                    Console.WriteLine($"è­‰æ›¸æœ‰æ•ˆæœŸ: {signerCert.NotBefore.ToLocalTime():yyyy-MM-dd HH:mm:ss} è‡³ {signerCert.NotAfter.ToLocalTime():yyyy-MM-dd HH:mm:ss} ({TimeZoneInfo.Local.DisplayName})");
                        }
                
                // é¡¯ç¤ºä½¿ç”¨çš„é›œæ¹Šæ¼”ç®—æ³•
                string digestAlgorithm = GetFriendlyAlgorithmName(signer.DigestAlgorithm);
                Console.WriteLine($"é›œæ¹Šæ¼”ç®—æ³•: {digestAlgorithm}");
                        
                        // æª¢æŸ¥æ™‚é–“æˆ³è¨˜
                        DateTime? signingTime = GetSigningTime(signer);
                        if (signingTime.HasValue)
                        {
                    Console.WriteLine($"ç°½ç½²æ™‚é–“ (UTC): {signingTime.Value.ToUniversalTime():yyyy-MM-dd HH:mm:ss} UTC");
                    Console.WriteLine($"ç°½ç½²æ™‚é–“ (æœ¬åœ°): {signingTime.Value.ToLocalTime():yyyy-MM-dd HH:mm:ss} {TimeZoneInfo.Local.DisplayName}");
                }
                
                // æª¢æŸ¥æ™‚é–“æˆ³è¨˜
                DisplayTimestampInfo(signer);
            }
        }

        // è¼”åŠ©æ–¹æ³•ï¼šæ ¹æ“šOIDç²å–å‹å¥½çš„æ¼”ç®—æ³•åç¨±
        private static string GetFriendlyAlgorithmName(Oid digestAlgorithm)
        {
            if (digestAlgorithm == null)
                return "Unknown";
                
            switch (digestAlgorithm.Value)
            {
                case "1.3.14.3.2.26":
                    return "SHA1";
                case "2.16.840.1.101.3.4.2.1":
                    return "SHA256";
                case "2.16.840.1.101.3.4.2.2":
                    return "SHA384";
                case "2.16.840.1.101.3.4.2.3":
                    return "SHA512";
                case "1.2.840.113549.1.1.4":
                    return "MD5";
                case "1.2.840.113549.1.1.5":
                    return "SHA1 with RSA";
                case "1.2.840.113549.1.1.11":
                    return "SHA256 with RSA";
                case "1.2.840.113549.1.1.12":
                    return "SHA384 with RSA";
                case "1.2.840.113549.1.1.13":
                    return "SHA512 with RSA";
                case "1.2.840.10045.4.1":
                    return "SHA1 with ECDSA";
                case "1.2.840.10045.4.3.2":
                    return "SHA256 with ECDSA";
                case "1.2.840.10045.4.3.3":
                    return "SHA384 with ECDSA";
                case "1.2.840.10045.4.3.4":
                    return "SHA512 with ECDSA";
                default:
                    return $"{digestAlgorithm.FriendlyName ?? "Unknown"} ({digestAlgorithm.Value})";
            }
        }
        
        // è¼”åŠ©æ–¹æ³•ï¼šé¡¯ç¤ºæ™‚é–“æˆ³è¨˜ä¿¡æ¯
        private static void DisplayTimestampInfo(SignerInfo signer)
        {
                        bool foundTimestamp = false;
                        foreach (CryptographicAttributeObject attr in signer.UnsignedAttributes)
                        {
                            if (attr.Oid.Value == "1.2.840.113549.1.9.16.2.14") // RFC 3161 timestamp
                            {
                                foundTimestamp = true;
                                Console.WriteLine("ç™¼ç¾RFC 3161æ™‚é–“æˆ³è¨˜");
                                try
                                {
                                    // å˜—è©¦ä½¿ç”¨BouncyCastleè§£æRFC 3161æ™‚é–“æˆ³è¨˜
                                    AsnEncodedData asnData = attr.Values[0];
                                    byte[] tokenBytes = asnData.RawData;
                                    
                                    TimeStampToken timestamp = new TimeStampToken(
                                        new CmsSignedData(tokenBytes));
                                    
                                    TimeStampTokenInfo info = timestamp.TimeStampInfo;
                        Console.WriteLine($"æ™‚é–“æˆ³è¨˜æ™‚é–“ (UTC): {info.GenTime.ToUniversalTime():yyyy-MM-dd HH:mm:ss} UTC");
                        Console.WriteLine($"æ™‚é–“æˆ³è¨˜æ™‚é–“ (æœ¬åœ°): {info.GenTime.ToLocalTime():yyyy-MM-dd HH:mm:ss} {TimeZoneInfo.Local.DisplayName}");
                                    Console.WriteLine($"æ™‚é–“æˆ³è¨˜åºè™Ÿ: {info.SerialNumber}");
                                    
                                    // ç²å–æ™‚é–“æˆ³è¨˜ç°½ç™¼è€…ä¿¡æ¯
                                    if (timestamp.SignerID != null)
                                    {
                                        Console.WriteLine($"æ™‚é–“æˆ³è¨˜ç°½ç™¼è€…: {timestamp.SignerID.Issuer}");
                                    }
                                }
                                catch (Exception rfc3161Ex)
                                {
                                    Console.WriteLine($"RFC 3161æ™‚é–“æˆ³è¨˜è™•ç†éŒ¯èª¤: {rfc3161Ex.Message}");
                                }
                            }
                            else if (attr.Oid.Value == "1.3.6.1.4.1.311.3.3.1") // Special Timestamp
                            {
                                foundTimestamp = true;
                                Console.WriteLine("ç™¼ç¾å…¶ä»–æ ¼å¼æ™‚é–“æˆ³è¨˜");
                                try
                                {
                                    // å˜—è©¦è™•ç†å…¶ä»–æ™‚é–“æˆ³è¨˜
                                    AsnEncodedData asnData = attr.Values[0];
                                    Asn1InputStream asnInputStream = new Asn1InputStream(asnData.RawData);
                                    Asn1Object asn1Object = asnInputStream.ReadObject();
                                    
                                    if (asn1Object != null)
                                    {
                                        // å˜—è©¦è§£ææ™‚é–“æˆ³è¨˜å€¼
                                        Asn1Sequence sequence = Asn1Sequence.GetInstance(asn1Object);
                                        if (sequence != null && sequence.Count >= 1)
                                        {
                                            Console.WriteLine($"å…¶ä»–æ ¼å¼æ™‚é–“æˆ³è¨˜è³‡è¨Š:");
                                            try
                                            {
                                                // å¾åºåˆ—ä¸­ç²å–GeneralizedTime
                                                if (sequence.Count >= 3 && sequence[2] is DerGeneralizedTime)
                                                {
                                                    DerGeneralizedTime timeValue = (DerGeneralizedTime)sequence[2];
                                        DateTime timeStampDateTime = timeValue.ToDateTime();
                                        Console.WriteLine($"æ™‚é–“æˆ³è¨˜æ™‚é–“ (UTC): {timeStampDateTime.ToUniversalTime():yyyy-MM-dd HH:mm:ss} UTC");
                                        Console.WriteLine($"æ™‚é–“æˆ³è¨˜æ™‚é–“ (æœ¬åœ°): {timeStampDateTime.ToLocalTime():yyyy-MM-dd HH:mm:ss} {TimeZoneInfo.Local.DisplayName}");
                                                }
                                            }
                                            catch (Exception timeEx)
                                            {
                                                Console.WriteLine($"æ™‚é–“æˆ³è¨˜æ™‚é–“è§£æéŒ¯èª¤: {timeEx.Message}");
                                            }
                                        }
                                    }
                                }
                                catch (Exception tsEx)
                                {
                                    Console.WriteLine($"è™•ç†å…¶ä»–æ ¼å¼æ™‚é–“æˆ³è¨˜éŒ¯èª¤: {tsEx.Message}");
                                }
                            }
                        }
                        
                        if (!foundTimestamp)
                        {
                            Console.WriteLine("æœªç™¼ç¾æ™‚é–“æˆ³è¨˜");
                        }
                    }
                    
        // å˜—è©¦ä½¿ç”¨åå°„è¨­ç½® SignedCms çš„å…§å®¹ï¼ˆç”¨æ–¼ç›¸å®¹æ€§ï¼‰
        private static void PrivateSetContentMethod(SignedCms cms, byte[] content)
        {
            try
            {
                // é¦–å…ˆå˜—è©¦ç›´æ¥ç”Ÿæˆä¸€å€‹æ–°çš„ContentInfo
                ContentInfo contentInfo = new ContentInfo(content);
                
                // å–å¾—SignedCmsçš„é¡å‹
                Type cmsType = cms.GetType();
                
                // å˜—è©¦æ–¹æ³•1ï¼šåå°„æ‰¾åˆ°_contentInfoå­—æ®µä¸¦è¨­ç½®
                try
                {
                    FieldInfo contentInfoField = cmsType.GetField("_contentInfo", BindingFlags.NonPublic | BindingFlags.Instance);
                    if (contentInfoField != null)
                    {
                        contentInfoField.SetValue(cms, contentInfo);
                        DebugLog("é€šéåå°„è¨­ç½®_contentInfoå­—æ®µæˆåŠŸ");
                        return;
                    }
                }
                catch (Exception reflectEx)
                {
                    DebugLog($"åå°„è¨­ç½®_contentInfoå­—æ®µå¤±æ•—: {reflectEx.Message}");
                }
                
                // å˜—è©¦æ–¹æ³•2ï¼šæŸ¥æ‰¾ä»»ä½•å¯èƒ½çš„set_ContentInfoæ–¹æ³•
                try
                {
                    var methods = cmsType.GetMethods(BindingFlags.NonPublic | BindingFlags.Instance | BindingFlags.Public);
                    
                    foreach (var method in methods)
                    {
                        if (method.Name.Contains("ContentInfo") && method.Name.StartsWith("set_"))
                        {
                            try
                            {
                                method.Invoke(cms, new object[] { contentInfo });
                                Console.WriteLine($"é€šéåå°„èª¿ç”¨{method.Name}æ–¹æ³•æˆåŠŸ");
                                return;
                            }
                            catch
                            {
                                // å¿½ç•¥æ–¹æ³•èª¿ç”¨å¤±æ•—ï¼Œç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹æ–¹æ³•
                            }
                        }
                    }
                }
                catch (Exception methodEx)
                {
                    DebugLog($"åå°„èª¿ç”¨set_ContentInfoæ–¹æ³•å¤±æ•—: {methodEx.Message}");
                }
                
                // ç²å–æ‰€æœ‰å­—æ®µç”¨æ–¼å¾ŒçºŒå˜—è©¦
                var allFields = cmsType.GetFields(BindingFlags.NonPublic | BindingFlags.Instance);
                
                // å˜—è©¦æ–¹æ³•3ï¼šå°‹æ‰¾åç¨±åŒ…å«Contentçš„å­—æ®µ
                try
                {
                    foreach (var field in allFields)
                    {
                        if (field.Name.Contains("content") || field.Name.Contains("Content"))
                        {
                            try
                            {
                                // å°æ–¼ContentInfoé¡å‹çš„å­—æ®µ
                                if (field.FieldType == typeof(ContentInfo))
                                {
                                    field.SetValue(cms, contentInfo);
                                    DebugLog($"é€šéå­—æ®µ{field.Name}è¨­ç½®å…§å®¹æˆåŠŸ");
                                    return;
                                }
                                // å°æ–¼byte[]é¡å‹çš„å­—æ®µ
                                else if (field.FieldType == typeof(byte[]))
                                {
                                    field.SetValue(cms, content);
                                    DebugLog($"é€šéå­—æ®µ{field.Name}è¨­ç½®å…§å®¹byte[]æˆåŠŸ");
                                    return;
                                }
                            }
                            catch
                            {
                                // å¿½ç•¥å­—æ®µè¨­ç½®å¤±æ•—ï¼Œç¹¼çºŒå˜—è©¦ä¸‹ä¸€å€‹å­—æ®µ
                            }
                        }
                    }
                }
                catch (Exception fieldEx)
                {
                    DebugLog($"åå°„è¨­ç½®å…§å®¹å­—æ®µå¤±æ•—: {fieldEx.Message}");
                }
                
                // å˜—è©¦æ–¹æ³•4ï¼šä½¿ç”¨æ–°çš„SignedCmså°è±¡æ›¿æ›
                try
                {
                    // å‰µå»ºä¸€å€‹æ–°çš„SignedCmså°è±¡ï¼Œä½¿ç”¨åŸå§‹ç°½åçš„ç·¨ç¢¼æ•¸æ“š
                    byte[] encodedData = cms.Encode();
                    SignedCms newCms = new SignedCms(contentInfo, false);
                    newCms.Decode(encodedData);
                    
                    // å˜—è©¦å°‡æ–°å°è±¡çš„å±¬æ€§è¤‡è£½å›åŸå§‹å°è±¡
                    foreach (var field in allFields)
                    {
                        try
                        {
                            var value = field.GetValue(newCms);
                            field.SetValue(cms, value);
                        }
                        catch
                        {
                            // å¿½ç•¥å±¬æ€§è¤‡è£½å¤±æ•—
                        }
                    }
                    
                    DebugLog("é€šéå‰µå»ºæ–°å°è±¡ä¸¦è¤‡è£½å±¬æ€§è¨­ç½®å…§å®¹æˆåŠŸ");
                }
                catch (Exception newCmsEx)
                {
                    DebugLog($"é€šéæ–°å°è±¡è¨­ç½®å…§å®¹å¤±æ•—: {newCmsEx.Message}");
                }
                
                DebugLog("è­¦å‘Šï¼šæ‰€æœ‰å˜—è©¦è¨­ç½®å…§å®¹çš„æ–¹æ³•éƒ½å¤±æ•—ï¼Œå°‡ç¹¼çºŒä½¿ç”¨åŸå§‹ç°½å");
            }
            catch (Exception ex)
            {
                DebugLog($"å˜—è©¦è¨­ç½®å…§å®¹æ™‚ç™¼ç”ŸéŒ¯èª¤: {ex.Message}");
            }
        }

        private static void EncryptFile(string filePath, string certIdentifier)
        {
            try
            {
                // è®€å–è¦åŠ å¯†çš„æª”æ¡ˆ
                byte[] fileContent = File.ReadAllBytes(filePath);
                
                // æŸ¥æ‰¾è­‰æ›¸
                X509Certificate2 certificate = null;
                if (string.IsNullOrEmpty(certIdentifier))
                {
                    certificate = SelectCertificateFromUI("encrypt");
                    if (certificate == null)
                    {
                        Console.WriteLine("æœªé¸æ“‡è­‰æ›¸ï¼ŒåŠ å¯†å·²å–æ¶ˆ");
                        return;
                    }
                }
                else
                {
                    // ç›´æ¥æŸ¥æ‰¾æŒ‡å®šçš„æ†‘è­‰æŒ‡ç´‹ï¼Œæ‰¾ä¸åˆ°æ‰é¡¯ç¤ºé¸æ“‡å°è©±æ¡†
                    certificate = FindCertificateDirectly(certIdentifier);
                    if (certificate == null)
                    {
                        Console.WriteLine($"æ‰¾ä¸åˆ°ç¬¦åˆ '{certIdentifier}' çš„è­‰æ›¸ï¼Œé–‹å•Ÿé¸æ“‡å°è©±æ¡†...");
                        certificate = SelectCertificateFromUI("encrypt");
                        if (certificate == null)
                        {
                            Console.WriteLine("æœªé¸æ“‡è­‰æ›¸ï¼ŒåŠ å¯†å·²å–æ¶ˆ");
                            return;
                        }
                    }
                }
                
                Console.WriteLine($"ä½¿ç”¨è­‰æ›¸: {certificate.Subject}");
                
                // å»ºç«‹ EnvelopedCms ç‰©ä»¶
                ContentInfo contentInfo = new ContentInfo(fileContent);
                EnvelopedCms envelopedCms = new EnvelopedCms(contentInfo);
                
                // ç‚ºæ”¶ä»¶è€…åŠ å¯†
                CmsRecipient recipient = new CmsRecipient(SubjectIdentifierType.IssuerAndSerialNumber, certificate);
                envelopedCms.Encrypt(recipient);
                
                // å–å¾—åŠ å¯†å¾Œçš„å…§å®¹
                byte[] encryptedData = envelopedCms.Encode();
                
                // å„²å­˜åŠ å¯†å¾Œçš„æª”æ¡ˆï¼Œçµ±ä¸€ä½¿ç”¨ .cms å‰¯æª”å
                string outputPath = filePath + ".cms";
                File.WriteAllBytes(outputPath, encryptedData);
                Console.WriteLine($"å·²åŠ å¯†æª”æ¡ˆ: {outputPath}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"åŠ å¯†å¤±æ•—: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"è©³ç´°éŒ¯èª¤: {ex.InnerException.Message}");
                }
            }
        }

        private static void DecryptFile(string filePath)
        {
            // åŸºæ–¼å‰¯æª”ååˆ¤æ–·æ–‡ä»¶é¡å‹
            bool isCertificateEncrypted = filePath.EndsWith(".p7m") || filePath.EndsWith(".cms") || filePath.EndsWith(".pgp");
            
            if (!isCertificateEncrypted)
            {
                throw new Exception("è«‹æä¾›æœ‰æ•ˆçš„åŠ å¯†æª”æ¡ˆ (.p7m, .cms, .pgp)");
            }
            
            // ä½¿ç”¨æ†‘è­‰è§£å¯†
            DecryptFileWithCertificate(filePath);
        }

        private static void DecryptFileWithCertificate(string filePath)
        {
            try
            {
                // è®€å–åŠ å¯†æª”æ¡ˆ
                byte[] encryptedData = File.ReadAllBytes(filePath);
                
                // å»ºç«‹ EnvelopedCms ç‰©ä»¶
                EnvelopedCms envelopedCms = new EnvelopedCms();
                
                try
                {
                    // å˜—è©¦è§£ç¢¼åŠ å¯†è³‡æ–™
                    envelopedCms.Decode(encryptedData);
                }
                catch (CryptographicException ex)
                {
                    // å¦‚æœè§£ç¢¼å¤±æ•—ï¼Œå¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„ CMS æ ¼å¼
                    throw new Exception($"ç„¡æ³•è§£ç¢¼åŠ å¯†è³‡æ–™: {ex.Message}");
                }
                
                // ä½¿ç”¨æ†‘è­‰è§£å¯†
                try
                {
                    envelopedCms.Decrypt();
                }
                catch (CryptographicException ex)
                {
                    // å¦‚æœè§£å¯†å¤±æ•—ï¼Œå¯èƒ½æ˜¯æ‰¾ä¸åˆ°åˆé©çš„æ†‘è­‰
                    Console.WriteLine($"ä½¿ç”¨ç•¶å‰ç”¨æˆ¶çš„æ†‘è­‰è§£å¯†å¤±æ•—: {ex.Message}");
                    
                    // å˜—è©¦ä½¿ç”¨PFX/P12æª”æ¡ˆè§£å¯†
                    Console.WriteLine("è«‹é¸æ“‡åŒ…å«ç§é‘°çš„PFX/P12æ†‘è­‰æª”æ¡ˆä»¥é€²è¡Œè§£å¯†...");
                    OpenFileDialog openFileDialog = new OpenFileDialog
                    {
                        Filter = "PFX/P12æ†‘è­‰æª”æ¡ˆ|*.pfx;*.p12|æ‰€æœ‰æª”æ¡ˆ|*.*",
                        Title = "é¸æ“‡PFX/P12æ†‘è­‰æª”æ¡ˆ"
                    };
                    
                    if (openFileDialog.ShowDialog() == DialogResult.OK)
                    {
                        Console.Write("è«‹è¼¸å…¥PFX/P12æª”æ¡ˆå¯†ç¢¼ (å¦‚ç„¡å¯†ç¢¼è«‹ç›´æ¥æŒ‰Enter): ");
                        string pfxPassword = ReadPfxPasswordFromConsole();
                        
                        try
                        {
                            X509Certificate2 cert = new X509Certificate2(
                                openFileDialog.FileName, 
                                pfxPassword, 
                                X509KeyStorageFlags.Exportable | X509KeyStorageFlags.PersistKeySet
                            );
                            
                            // å»ºç«‹æ–°çš„EnvelopedCmsç‰©ä»¶
                            EnvelopedCms newEnvelopedCms = new EnvelopedCms();
                            newEnvelopedCms.Decode(encryptedData);
                            
                            // ä½¿ç”¨è¼‰å…¥çš„æ†‘è­‰è§£å¯†
                            X509Certificate2Collection certificates = new X509Certificate2Collection(cert);
                            newEnvelopedCms.Decrypt(certificates);
                            
                            // æ›´æ–°è§£å¯†å¾Œçš„å…§å®¹
                            envelopedCms = newEnvelopedCms;
                        }
                        catch (Exception pfxEx)
                        {
                            throw new Exception($"ä½¿ç”¨PFX/P12æ†‘è­‰è§£å¯†å¤±æ•—: {pfxEx.Message}");
                        }
                    }
                    else
                    {
                        throw new Exception("è§£å¯†å·²å–æ¶ˆã€‚æ‰¾ä¸åˆ°é©åˆè§£å¯†çš„æ†‘è­‰ã€‚");
                    }
                }
                
                // ç²å–è§£å¯†å¾Œçš„å…§å®¹
                byte[] decryptedContent = envelopedCms.ContentInfo.Content;
                
                // å„²å­˜è§£å¯†å¾Œçš„æª”æ¡ˆ
                string outputPath = filePath;
                if (filePath.EndsWith(".cms") || filePath.EndsWith(".p7m") || filePath.EndsWith(".pgp"))
                {
                    outputPath = filePath.Substring(0, filePath.LastIndexOf('.')) + ".decrypted";
                }
                else
                {
                    outputPath = filePath + ".decrypted";
                }
                
                File.WriteAllBytes(outputPath, decryptedContent);
                Console.WriteLine($"æª”æ¡ˆè§£å¯†æˆåŠŸ: {outputPath}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"è§£å¯†å¤±æ•—: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"è©³ç´°éŒ¯èª¤: {ex.InnerException.Message}");
                }
            }
        }

        // è®€å–PFX/P12æª”æ¡ˆå¯†ç¢¼
        private static string ReadPfxPasswordFromConsole()
        {
            string password = string.Empty;
            ConsoleKeyInfo key;
            
            do
            {
                key = Console.ReadKey(true);
                
                // è™•ç†é€€æ ¼éµ
                if (key.Key == ConsoleKey.Backspace && password.Length > 0)
                {
                    Console.Write("\b \b");
                    password = password.Substring(0, password.Length - 1);
                }
                // è™•ç†å…¶ä»–æŒ‰éµ
                else if (!char.IsControl(key.KeyChar))
                {
                    Console.Write("*");
                    password += key.KeyChar;
                }
            } while (key.Key != ConsoleKey.Enter);
            
            Console.WriteLine();
            return password;
        }

        private static X509Certificate2 FindCertificateDirectly(string identifier)
        {
            if (string.IsNullOrEmpty(identifier))
            {
                return null;
            }

            // å˜—è©¦å¾å€‹äººå­˜æ”¾å€å°‹æ‰¾è­‰æ›¸
            using (X509Store store = new X509Store(StoreName.My, StoreLocation.CurrentUser))
            {
                store.Open(OpenFlags.ReadOnly);

                // è™•ç†SHA1æŒ‡ç´‹ (ä¸å€åˆ†å¤§å°å¯«ä¸¦ç§»é™¤ç©ºæ ¼å’Œå†’è™Ÿ)
                string cleanIdentifier = identifier.Replace(" ", "").Replace(":", "").Replace("-", "").ToLowerInvariant();

                // é¦–å…ˆå°‹æ‰¾å®Œå…¨åŒ¹é…çš„è­‰æ›¸æŒ‡ç´‹
                foreach (X509Certificate2 cert in store.Certificates)
                {
                    if (cert.HasPrivateKey)
                    {
                        string thumbprint = cert.Thumbprint.Replace(" ", "").Replace(":", "").Replace("-", "").ToLowerInvariant();
                        
                        if (string.Equals(thumbprint, cleanIdentifier, StringComparison.OrdinalIgnoreCase))
                        {
                            return new X509Certificate2(cert);
                        }
                    }
                }
                
                // å¦‚æœæ²’æœ‰æ‰¾åˆ°åŒ¹é…çš„æŒ‡ç´‹ï¼Œå˜—è©¦ä¸»é¡Œåç¨±å’Œåºè™ŸåŒ¹é…
                foreach (X509Certificate2 cert in store.Certificates)
                {
                    if (cert.HasPrivateKey)
                    {
                        if (cert.Subject.IndexOf(identifier, StringComparison.OrdinalIgnoreCase) >= 0 ||
                            string.Equals(cert.SerialNumber, identifier, StringComparison.OrdinalIgnoreCase))
                        {
                            return new X509Certificate2(cert);
                        }
                    }
                }
            }

            // å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…çš„è­‰æ›¸ï¼Œè¿”å›null
            return null;
        }

        // å‰µå»ºé›œæ¹Šæ¼”ç®—æ³•ï¼Œé¿å…ä½¿ç”¨å·²æ·˜æ±°çš„HashAlgorithm.Create(string)æ–¹æ³•
        private static HashAlgorithm CreateHashAlgorithm(string algorithm)
        {
            switch (algorithm.ToUpper())
            {
                case "SHA1":
                    return System.Security.Cryptography.SHA1.Create();
                case "SHA256":
                    return System.Security.Cryptography.SHA256.Create();
                case "SHA384":
                    return System.Security.Cryptography.SHA384.Create();
                case "SHA512":
                    return System.Security.Cryptography.SHA512.Create();
                default:
                    return System.Security.Cryptography.SHA384.Create(); // é è¨­ä½¿ç”¨SHA384
            }
        }

        // ç²å–é›œæ¹Šæ¼”ç®—æ³•çš„OID
        private static string GetHashAlgorithmOid(string algorithm)
        {
            switch (algorithm.ToUpper())
            {
                case "SHA1":
                    return "1.3.14.3.2.26";
                case "SHA256":
                    return "2.16.840.1.101.3.4.2.1";
                case "SHA384":
                    return "2.16.840.1.101.3.4.2.2";
                case "SHA512":
                    return "2.16.840.1.101.3.4.2.3";
                default:
                    return "2.16.840.1.101.3.4.2.2"; // SHA384
            }
        }

        private static void EncryptFileWithCertFile(string filePath, string certFilePath)
        {
            try
            {
                // è®€å–è¦åŠ å¯†çš„æª”æ¡ˆ
                byte[] fileContent = File.ReadAllBytes(filePath);
                
                // å¾æª”æ¡ˆè¼‰å…¥æ†‘è­‰
                X509Certificate2 certificate = null;
                try
                {
                    certificate = new X509Certificate2(certFilePath);
                }
                catch (Exception ex)
                {
                    throw new Exception($"è¼‰å…¥æ†‘è­‰æª”æ¡ˆå¤±æ•—: {ex.Message}");
                }
                
                Console.WriteLine($"ä½¿ç”¨æª”æ¡ˆæ†‘è­‰: {certificate.Subject}");
                
                // å»ºç«‹ EnvelopedCms ç‰©ä»¶
                ContentInfo contentInfo = new ContentInfo(fileContent);
                EnvelopedCms envelopedCms = new EnvelopedCms(contentInfo);
                
                // ç‚ºæ”¶ä»¶è€…åŠ å¯†
                CmsRecipient recipient = new CmsRecipient(SubjectIdentifierType.IssuerAndSerialNumber, certificate);
                envelopedCms.Encrypt(recipient);
                
                // å–å¾—åŠ å¯†å¾Œçš„å…§å®¹
                byte[] encryptedData = envelopedCms.Encode();
                
                // å„²å­˜åŠ å¯†å¾Œçš„æª”æ¡ˆï¼Œçµ±ä¸€ä½¿ç”¨ .cms å‰¯æª”å
                string outputPath = filePath + ".cms";
                File.WriteAllBytes(outputPath, encryptedData);
                Console.WriteLine($"å·²åŠ å¯†æª”æ¡ˆ: {outputPath}");
            }
            catch (Exception ex)
            {
                Console.WriteLine($"ä½¿ç”¨æ†‘è­‰æª”æ¡ˆåŠ å¯†å¤±æ•—: {ex.Message}");
                if (ex.InnerException != null)
                {
                    Console.WriteLine($"è©³ç´°éŒ¯èª¤: {ex.InnerException.Message}");
                }
            }
        }

        // èª¿è©¦æ—¥èªŒè¼”åŠ©æ–¹æ³• - åªåœ¨èª¿è©¦æ¨¡å¼ä¸‹è¼¸å‡ºè¨Šæ¯
        private static void DebugLog(string message)
        {
            if (_debugMode)
            {
                Console.WriteLine($"[DEBUG] {message}");
            }
        }

        // æ–°å¢å¹«åŠ©æ–¹æ³•ä¾†ç²å–ç°½ç½²æ™‚é–“
        private static DateTime? GetSigningTime(SignerInfo signerInfo)
        {
            foreach (CryptographicAttributeObject attr in signerInfo.SignedAttributes)
            {
                if (attr.Oid.Value == "1.2.840.113549.1.9.5") // signingTime
                {
                    if (attr.Values.Count > 0)
                    {
                        var encodedTime = (Pkcs9SigningTime)attr.Values[0];
                        return encodedTime.SigningTime;
                    }
                }
            }
            
            return null;
        }
    }
}  ‚¾0‚º0‚¢ O
•Cô€œ±Ûãgrõ°ô0	*†H†÷ 0G10	UTW10U
	è¡Œæ”¿é™¢1$0"Uå…§æ”¿éƒ¨æ†‘è­‰ç®¡ç†ä¸­å¿ƒ0250217083715Z300217155959Z0<10	UTW10U	æ—å“²å…¨10U11654032303027140‚"0	*†H†÷ ‚ 0‚
‚ ÆDf;_?äPºI¹"Ñ\Œw’Ëù o½D¯É,\u¨‡qìâô‘/­¹al#Ü¯ÈC`.;£OP5Y´Y‡´EÆ,„…¿F7„»ú6Š‹äFù,oÑ pTrB…“zqÅû!´Î=\@ëföó>äe1ag¡óŠæØÜÒz‹”È±gûä*ÈÖ_.ÄÒ“õ5WFih4?GuFmKQ©Ë•8™ŸŸFıú¤¾c%/Js-€ ğ€åı\ëoÅ²v9è„Êu°ÊòäĞ±GúÆ£ãâ\»z\q­
,X7RGê:ş†Æªäékv£šYƒ„6Wl1!Ğ[É¬í £‚«0‚§0U#0€G £±&KÍmH¬òd†—,tT_0UîÑmıXKC5ìmyQÃ:ÜÈ0Uÿ€0U 00	`†ve 03U	,0*0`†vd1
`†vd0`†vd3117380€Uy0w08 6 4†2http://crl-moica.moi.gov.tw/crl/MOICA-G3-10-31.crl0; 9 7†5http://crl-moica.moi.gov.tw/crl/MOICA-G3-complete.crl0†+z0x0G+0†;http://moica.nat.gov.tw/repository/Certs/IssuedToThisCA.p7b0-+0†!http://ocsp-moica.moi.gov.tw/OCSP0	*†H†÷ ‚ *fk!÷í±Á:™K\}'mÖE•äğ…Ûkq‰›¡µ#|ùLìQØ$¶7GsÚ%SBõŒÔxŠ$byÑ$IYAã‚ùk‡ı·tTæ²q™–qmaZn+™6$‡Zøõâ¬‚Bù©ßãä»¡§<–ûI²íå	Ÿ•¸VH†_î2xÈa’ì?‹§›Ø«uWJx;G‹ß_óàğøõs<KjåvÒšcXCâ 2ÚO*jM˜¦o”&£6··ªúòN!{¦«ãNÚ;ÖÙº‹+¹Âe_k æ?ÖË§SQb´„ÿ½‰–²Xº#_(ÑbtóXğ—Õ	A¨¨:B	á_B˜uÛÕÎä0‚ñ›+5ú´¤g;*¼Š~Ã–ÃQ´<œ6,0&$\òïÊç$é­´å`4®­V=TÉq.æ›ìB{ÊâÏD~¡Ï¸sF¤ªi€]’8$Ü5gëQûúy=ş-Î¶±8hÊROì°“¹ùV¶ÚÌ|øÈs>XL¤»ïBÆoXœ_+†e$t¼Ò–¤BVÙ"*©åc&7Ú-Nøú›äî9iº§vĞ8”¾¾ßòcp°ÂRtoòGTÒŸ….LQ³ ‰¬Œr]Jë­m7™DJlµ*ƒv«0*[ì#¼y0n—)1‚u0‚q0[0G10	UTW10U
	è¡Œæ”¿é™¢1$0"Uå…§æ”¿éƒ¨æ†‘è­‰ç®¡ç†ä¸­å¿ƒO
•Cô€œ±Ûãgrõ°ô0	`†He0	*†H†÷‚ ÂpÃØ¥IæŸ†¼Í,]=ŸÒ×	êÓØ–?¢Uk±ŸÒJâÁšØ"˜œr	şrƒ‡{“KàÄa)zuÖµÔÀ{"]A·ş]lÕ›¼4ÊJÍ ğ$ÅÀÆº²Éo\«T‘:`µ"rºÍ¯_3,Yi‡‰úñë´Õås.ŠÊøŠ¾Î©$ãM²%­Böc =çÍp›ƒ4¯DÆ‡L.À4=>ùÍ¢Í¦+Á8HGóë§-š¡Dæ6ä‡¤P1/Ì©D£ª7K
õ·Tä
u¬~§£±ú8YY(ÙöÙR®ª1@P÷;·¶€	5*¢¨t(øOı!¡‚ï0‚ë*†H†÷	1‚Ú0‚Ö	*†H†÷ ‚Ç0‚Ã10	`†He0‚*†H†÷	 øõ0ò+ 20Q0	`†He @Ïôµ¢İn[i/â+€ à„p'MÈò1ÂìÉòÿ”_ï*VT¥ìÜä#©d>ç•`ÕéöûÄg·›•”â¥¢Wd2¿ßbûn»÷’^uE£•d20250312124458Z0 a¤_0]10	UBE10U
GlobalSign nv-sa1301U*Globalsign TSA for CodeSign1 - R6 - 202311 ‚T0‚l0‚T ›êŞÈMk÷l:Ÿ.$0	*†H†÷ 0[10	UBE10U
GlobalSign nv-sa110/U(GlobalSign Timestamping CA - SHA384 - G40231107171340Z341209171340Z0]10	UBE10U
GlobalSign nv-sa1301U*Globalsign TSA for CodeSign1 - R6 - 2023110‚¢0	*†H†÷ ‚ 0‚Š‚ ê„7Ph<•…µHTq—ó„rÉ€ÓÜY»¿ËMiG‰å,Øñ¨j~`7Is›¸˜³àïŒ“p µõ+×fu?z„P©RàÖçoÔ5.à/)$£w%'à¸ó}dušBåÆâØ‡s‹ï —~ Ä²FÏ`ÆÏP€İOéäF¢4§>Çk´¶û¾Ú©V~œ]6=c4!KÈÒ£>/Qhuùüp„e3³Fe(„ 3À’í¸‰cĞ{,[°ô½rcÎ°1!jr²",ïë*;Õñšô&¢,üSy#iQÓ]¾s„Ë›ƒˆm Ò Î«j"KyBæ‚B¯ëÔĞÚƒzÃ-HñÍE‘·Aİï@ü¢²ÀYªT—NmÃzİ††Ô;7G8è<1¿L3{CìğĞÿe¦Ÿ˜=ÒÆºY"lXÅÌè¢˜°3Ğó•øíq´AÕdy¢¼`.ÃzÉŞp7>]8°‰g‹¥- Û¸Öõœõ¼ˆ¿',Ãù ¢Á £‚¨0‚¤0Uÿ€0U%ÿ0
+0UùN«¾¸ø[ÿÂÇôAîœøÖt}?0VU O0M0g0A	+ 20402+&https://www.globalsign.com/repository/0Uÿ0 0+ƒ0€09+0†-http://ocsp.globalsign.com/ca/gstsacasha384g40C+0†7http://secure.globalsign.com/cacert/gstsacasha384g4.crt0U#0€êÆiçãËWE93¤ğ@¾ĞÃ½e–0AU:0806 4 2†0http://crl.globalsign.com/ca/gstsacasha384g4.crl0	*†H†÷ ‚ •ôgÏ“šC’ƒvÖ U¼‰ÿä_²å·—@. A¾Å?$ G3L´´bÿÆîÓÂ4 ”\7˜ëDø_ø'
¾Ñ$#Ë/«'z³©Å/äåğ$£øïƒèO»h#o}=qpa2|FnòÑœèCMúƒáÿÄà>şŞWßkójh«|*÷BÿÀsiÛ§O&Xsí”^ä¢‚2;Ê¿İ9uÔ¼‹T?~P•4Ÿ’9$SƒPÔ[/f´{ş[)ëÅı£=û¡°ó+y±K¬Ã£Ù£Ü,œ+#–öz*»­ÅW¶„¶c³`˜ìÆÖfo"ƒŠXôìœNĞßîÎa!Óµ•TI;!Q=¡#…’Â[òz”„˜
$V"Šú´š‰H5øoë†SÀ“{:´Ô4ÌbÖ5a¦Pûˆt×15!¿«£dSTâsf¤ûfcá7ÉÄkû+3‹ÃtƒÈO†ÊİJ—Û~P%¡aì†›6RË>bUì3¦å¸úİ$.ù2‰1j5•şöÑÿŠ®#	+!®bî÷î7ç°É³ívš·ıçşáhŞDÁ
tá•ÈWûëZß–uÅe÷ôÕ!¯c¶ëôâFŸ·×nj+şéÒqNÒ¾ObÓIÖ`_@ãv™ DØJ\³]Ùâª¿MY `g:G 0‚Y0‚A ì’@Şı.@]|Gt0	*†H†÷ 0L1 0UGlobalSign Root CA - R610U

GlobalSign10U
GlobalSign0180620000000Z341210000000Z0[10	UBE10U
GlobalSign nv-sa110/U(GlobalSign Timestamping CA - SHA384 - G40‚"0	*†H†÷ ‚ 0‚
‚ ğâ0#úàášt³¯uƒ_©GRÇa:c|9#ymtü1ät–úÎ'b[®Š'îW£Ä5í³4Ç¬Ãë€fmÑ(JÁ,»¹pòr®Œ÷™Z]v®¿D¨|A$ºÅOÿ6A«§-ıxNCˆş“Ùî1Ï¼Š;njÄˆğî—öÜó K™‡§&áˆÉ å™âôœL?][ì¶ïÒeÏET=±TS‹™n¸T™Š¨1’;òz}üXßjá°le‚*Ô!Ç”şB–;ñ±F˜‡=zeëÑV©.½ûX=µ…úS™M[tírK¢‚7Ğ«êZÁïÕ™¹?ôO5ñœÓ7RÙ%4í–ïøgê¾Izÿ±Ô÷)×ù]Ö‡CtÄp(´€{½*›»„á¬o¹µömVşŠ	>$g&Çü² ”°²”Ì{ægş¦X²ÔØAÁUın‘Å»±LKÔBoÕ6êd®ÎıõæâfĞ!¬±#äû4Dê®Ig‹‚å­Z†§fı3Ş™%ùqnéœ]L`<Ïırî’ñ§ŞBMì©&åw¬W	Ña&ˆüÈ²MÛdğEŸºÁ?T£Øv•ljÊ"\öã)úK°Ó7t„Ùf«4s}|^–Ö=°—êŒP‘m¯W†~7kß £‚)0‚%0Uÿ†0Uÿ0ÿ 0UêÆiçãËWE93¤ğ@¾ĞÃ½e–0U#0€®l£“â¢çâ×ÖÇğÈgS 0>+2000.+0†"http://ocsp2.globalsign.com/rootr606U/0-0+ ) '†%http://crl.globalsign.com/root-r6.crl0GU @0>0<U  0402+&https://www.globalsign.com/repository/0	*†H†÷ ‚ âˆÙWg+B_§	ºÄ»(VÖL¿ÛpÆû	­ :`39Æk@I%ä›÷Ö¤–ò†¢ŞA¿Oá¼«ÍîÀ#ŒÆ…şK$ùDìÂ¤¬Ğ²ÏìÂVe½öŞ‚È·ŸaÓµFH˜—gz•JÛbÆĞ³Ì4HEUİìéJŸ^írqvpÒ–óê7W”‘¯Ü™8XÂ©¡~¢n&ê´ù*ççHdi/Òš¡rö÷$KtZ}r†5³W‹œü»¬LŞúŞSLƒı±¶IUOu¬oJÈ.j¹ÊˆÃ0N²sŸ^¡Ö™Îé}K–,ÌkÍäY7†	,âEÖ²Ín‚u¥Ú·[/ˆ.=}ñò‘0œÎ{| Å¬¯QğÇ0ÅQV`è|•="ãÕ
$S'—€úH‰',yâ<å›ãª„‚‰>ÀJõ!şbí0üöÌêH'|‹uBkËó¥k•X4
‰í‚PäÑ{¨Éæ¾Hª+UÙ·% Q ÔcªƒêlraJÉúCÄÆWÅ¶<°‹°¹1ï½ïØ@l Â-èÆmŒ¶qíR!ş>öŸŸ9®¬Ò/z ±ô¬ªâ-ú–jÆ<ÊóÙ¿SM¤GY|•ÄCAù%â,~ù”§}òµ	õØ`r@P• ÔCD¾ú •ç Y¶xÆ¤jª"›0‚ƒ0‚k Eæ»ƒ3Ã…eHæÿEQ0	*†H†÷ 0L1 0UGlobalSign Root CA - R610U

GlobalSign10U
GlobalSign0141210000000Z341210000000Z0L1 0UGlobalSign Root CA - R610U

GlobalSign10U
GlobalSign0‚"0	*†H†÷ ‚ 0‚
‚ •èsÊfùìÊ{<÷ñ´E,‚´HÆë[<®ƒ¸A’3¤oé*ÌÆ°ˆkÅ¶‰ÑÆ²ÿÎQ!ìJİZÆÖ‡îM:ídf’€ÊDŞs”Nó§‰OxcÈPmBf/M¹y(MRŠ€·~ÄŠ¼dL!Ch×=<ŠÅ²fÕš·1Å¾âm2¦ù¹ëª£¸¿¾‚cPĞğ‰ßäyõê¢*Òp.{ç¼“»mSâH|Œ8ÿf²wa~àêŒ<ª´¤öó•JmıŒ²‰ÏĞ awÈXt°Ô#:÷]:Ê¢Û	Ş]D-ñÍW’ú~¼Pc4ßk“¾k6²9ä¬$6·ğï¶W“¶Ş²øâ…·s¢¸5ªEòà6¡oTŠñrVn.ˆÅQBD”î£Å8–›NNZGó6Iw0¼q7å¦ì!uüæa?wÕÙ‘—„
lÔMtÀíı9ûƒò^¡°éşîán²³af	j±:e–YÀğ5ıÉÚ(‡p
¨šu:† Û€Ö%ùÜ'YLv9[êù¥¡ØƒÑÿß0ù…Ï3HõÊmd,zXOÓKIÅ•dcy=õ³ŒÊX­œBEyn‡\T±e¶¿Œ›Üéo¸.ÜgnÉ‹µ„Š pƒy‘—‘Ô'¿72Øc<(L¯ £c0a0Uÿ0Uÿ0ÿ0U®l£“â¢çâ×ÖÇğÈgS 0U#0€®l£“â¢çâ×ÖÇğÈgS 0	*†H†÷ ‚ ƒ%íèÑı•RÍÀ ‘iæ\Ğ„ŞÜ­¢OèGxÖe˜©[¨<‡|ŠÑn·sæ_ÀT˜Õt¾ÁÍâ‘­#=İárD–´•^À{™xCVW³¢³;µwÜ@r¬£ë›5>±!¡çÄC7y2¾µçœ,L¼C)™0Ó¬!àãúØ3vT "*¹M .phÚåSüƒ\ÓòÿDDfòÒã½F mº%]¡1QİTFMÛ™–ï\¦ïxàyş]Û>ªLUıš©oá¦ûßp0éÃîBFíÂ“‰ú}c{?Ğq| è˜®x4Ã%û¯
Ÿ kİ;ŒâAHzs wiÇ¶\‚ÈşX(+¨l­^mÀÒ{·ë€ş%7ş›h¬B]ÃîõÌÜğPuÒ6iœæ{ßni¶Ş
	HY‡ë{`zdªiCï‘ÇLìİlïS-Œ™á^òr>ÏTÈ½gì¤LEÿÓ¹0#L¿†–Ù™Z´™W¤Ì»‰Sº,äÄ±4ÕLºí÷¯$•x¨»îåÚ_|‹J¡t%§³>KÈ,V½ÇÈï8â\’ğy÷œ„ºt-a ~~ÑòOY_‹-CRëF”áõfGywÕT[­$7ËEZN DHÈØ°™Å„	öÖIIÀe¸æqn ¨ñ‚èE>lÖ×
gƒZÉ¤1‚I0‚E0o0[10	UBE10U
GlobalSign nv-sa110/U(GlobalSign Timestamping CA - SHA384 - G4›êŞÈMk÷l:Ÿ.$0	`†He ‚-0	*†H†÷	1*†H†÷	0+	*†H†÷	4100	`†He¡	*†H†÷ 0/	*†H†÷	1" e„šù€YYOMÉ¹Î}1Öy¼®O+? K[Cì!U0°*†H†÷	/1 00š0— :ˆz•^¹*^áOl»v‚7¥EĞ[ğE½â_‚©Ñè0s0_¤]0[10	UBE10U
GlobalSign nv-sa110/U(GlobalSign Timestamping CA - SHA384 - G4›êŞÈMk÷l:Ÿ.$0	*†H†÷ ‚€ÀkAÀ”5!†0â1	õ‰h•ñê«™ŒŞI<RòÖ»Ä$°e¶q5¨ÄB³K7{°·©İl"]à¹¨&˜´ºÛq½Aô3p¶ƒ:É&eµO¶•šŞ»˜QÒ/ÔÀ-éS	"@y©XÎb­õG0­İliS]No5}#Z…±xñìCıU´÷W,Æ7E…¤Ñãáo…¡QâódŠy—ì\ŒÈ.S°81„x˜))æükV¹;zqEµ&,·Š±ëFò1Ë‚
Ñ ıÚT<áª n y…Ô^‡!:4ÊØkTÁ)fšCŞ„­2*qs:¢ïµòŒÖ‰}b~öŞ ?‘ÊTš;aDáĞ[¡Û —µÔÙÈTÚvÈ1›Ú¿“Éi°µö$L¼‹İò7 }÷G¬ÎJÌöŒÈOMŠc†Éìõ-öP›x"1¡Ç¿©ğešS‡óì£ªûLú˜GgÂ28ñÏÓ»!
qèOQú#!›…ò